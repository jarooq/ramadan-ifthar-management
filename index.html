<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ifthar Project Management</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #1a6b4a;
            --primary-light: #e8f5ef;
            --primary-dark: #0d4a30;
            --accent: #c8a23d;
            --accent-light: #fdf6e3;
            --danger: #dc3545;
            --danger-light: #fde8ea;
            --warning: #f0ad4e;
            --warning-light: #fff8ec;
            --success: #28a745;
            --info: #17a2b8;
            --gray-50: #f8f9fa;
            --gray-100: #e9ecef;
            --gray-200: #dee2e6;
            --gray-300: #ced4da;
            --gray-500: #6c757d;
            --gray-700: #495057;
            --gray-900: #212529;
            --radius: 10px;
            --shadow: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-lg: 0 4px 20px rgba(0,0,0,0.12);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--gray-50); color: var(--gray-900); line-height: 1.5; }
        .header { background: linear-gradient(135deg, var(--primary-dark), var(--primary)); color: white; padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; box-shadow: var(--shadow-lg); position: sticky; top: 0; z-index: 100; }
        .header-left { display: flex; align-items: center; gap: 12px; }
        .header h1 { font-size: 1.3rem; font-weight: 700; }
        .header .subtitle { font-size: 0.8rem; opacity: 0.85; }
        .header-logo { width: 40px; height: 40px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: 700; }
        .header-right { display: flex; gap: 8px; flex-wrap: wrap; }
        .nav-tabs { display: flex; justify-content: center; background: white; border-bottom: 2px solid var(--gray-100); padding: 0 16px; overflow-x: auto; }
        .nav-tab { padding: 14px 18px; cursor: pointer; font-weight: 500; color: var(--gray-500); border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap; font-size: 0.88rem; }
        .nav-tab:hover { color: var(--primary); background: var(--primary-light); }
        .nav-tab.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 600; }
        .main { max-width: 1100px; margin: 0 auto; padding: 16px; }
        .page { display: none; }
        .page.active { display: block; }
        .card { background: white; border-radius: var(--radius); box-shadow: var(--shadow); padding: 20px; margin-bottom: 16px; }
        .card-title { font-size: 1rem; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .stat-card { background: white; border-radius: var(--radius); box-shadow: var(--shadow); padding: 16px 20px; border-left: 4px solid var(--primary); }
        .stat-card.accent { border-left-color: var(--accent); }
        .stat-card.danger { border-left-color: var(--danger); }
        .stat-card.success { border-left-color: var(--success); }
        .stat-card.info { border-left-color: var(--info); }
        .stat-card.warning { border-left-color: var(--warning); }
        .stat-label { font-size: 0.75rem; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
        .stat-value { font-size: 1.6rem; font-weight: 700; margin-top: 4px; }
        .stat-sub { font-size: 0.75rem; color: var(--gray-500); margin-top: 2px; }
        .form-row { display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap; }
        .form-group { flex: 1; min-width: 160px; }
        .form-group label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--gray-700); margin-bottom: 4px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 9px 12px; border: 1.5px solid var(--gray-200); border-radius: 6px; font-size: 0.9rem; transition: border-color 0.2s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(26,107,74,0.1); }
        .btn { padding: 9px 18px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-accent { background: var(--accent); color: white; }
        .btn-accent:hover { background: #b08f2f; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #c82333; }
        .btn-outline { background: white; color: var(--gray-700); border: 1.5px solid var(--gray-200); }
        .btn-outline:hover { background: var(--gray-50); border-color: var(--gray-300); }
        .btn-sm { padding: 5px 10px; font-size: 0.78rem; }
        .btn-success { background: var(--success); color: white; }
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { background: var(--gray-50); font-size: 0.72rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--gray-500); padding: 10px 12px; text-align: left; border-bottom: 2px solid var(--gray-100); }
        td { padding: 10px 12px; border-bottom: 1px solid var(--gray-100); font-size: 0.85rem; }
        tr:hover td { background: var(--gray-50); }
        .badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 0.72rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; }
        .badge-pending { background: var(--warning-light); color: #946b00; }
        .badge-scheduled { background: var(--warning-light); color: #946b00; }
        .badge-cooking { background: #fff0e6; color: #e65100; }
        .badge-cooked { background: #e8f5ef; color: var(--primary); }
        .badge-distributed { background: #e3f2fd; color: #1565c0; }
        .badge-reported { background: #f3e8fd; color: #7b1fa2; }
        .status-pills { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px; }
        .status-pill { padding: 8px 14px; border-radius: 20px; font-size: 0.78rem; font-weight: 600; border: 2px solid var(--gray-200); background: white; color: var(--gray-500); cursor: pointer; transition: all 0.2s; text-transform: uppercase; letter-spacing: 0.3px; }
        .status-pill:hover { border-color: var(--gray-300); background: var(--gray-50); }
        .status-pill.active-scheduled { background: var(--warning-light); color: #946b00; border-color: #f0ad4e; }
        .status-pill.active-cooking { background: #fff0e6; color: #e65100; border-color: #e65100; }
        .status-pill.active-cooked { background: #e8f5ef; color: var(--primary); border-color: var(--primary); }
        .status-pill.active-distributed { background: #e3f2fd; color: #1565c0; border-color: #1565c0; }
        .status-pill.active-reported { background: #f3e8fd; color: #7b1fa2; border-color: #7b1fa2; }
        .badge-daily { background: #e8f5ef; color: var(--primary); }
        .badge-alternate { background: #fff3cd; color: #856404; }
        .badge-weekly { background: #e3f2fd; color: #1565c0; }
        .badge-weekly-total { background: #f3e8fd; color: #7b1fa2; }
        .badge-auto { background: #fff0e6; color: #e65100; }
        .progress-bar { height: 8px; background: var(--gray-100); border-radius: 4px; overflow: hidden; margin-top: 6px; }
        .progress-fill { height: 100%; border-radius: 4px; transition: width 0.3s; }
        .progress-fill.green { background: var(--success); }
        .progress-fill.yellow { background: var(--warning); }
        .progress-fill.red { background: var(--danger); }
        .days-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 10px; }
        .day-card { background: white; border: 1.5px solid var(--gray-200); border-radius: 8px; padding: 12px; cursor: pointer; transition: all 0.2s; }
        .day-card:hover { border-color: var(--primary); box-shadow: var(--shadow); }
        .day-card.status-pending { border-left: 4px solid var(--warning); }
        .day-card.status-scheduled { border-left: 4px solid var(--warning); }
        .day-card.status-cooking { border-left: 4px solid #e65100; }
        .day-card.status-cooked { border-left: 4px solid var(--success); }
        .day-card.status-distributed { border-left: 4px solid var(--info); }
        .day-card.status-reported { border-left: 4px solid #7b1fa2; }
        .day-card .day-num { font-weight: 700; font-size: 1rem; color: var(--primary); }
        .day-card .day-date { font-size: 0.72rem; color: var(--gray-500); }
        .day-card .day-meals { font-size: 0.85rem; font-weight: 600; margin-top: 6px; }
        .day-card .day-status { margin-top: 4px; }
        .day-card .day-orgs { font-size: 0.68rem; color: var(--gray-500); margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .day-card.today { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(200,162,61,0.3); }
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: white; border-radius: var(--radius); box-shadow: var(--shadow-lg); width: 90%; max-width: 560px; max-height: 85vh; overflow-y: auto; padding: 24px; }
        .modal-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; }
        .modal-close { background: none; border: none; font-size: 1.4rem; cursor: pointer; color: var(--gray-500); padding: 4px; }
        .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 12px; font-size: 0.85rem; font-weight: 500; display: flex; align-items: center; gap: 8px; }
        .alert-warning { background: var(--warning-light); color: #946b00; border: 1px solid #f0ad4e44; }
        .alert-danger { background: var(--danger-light); color: var(--danger); border: 1px solid #dc354544; }
        .alert-success { background: var(--primary-light); color: var(--primary); border: 1px solid #1a6b4a33; }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--gray-500); }
        .empty-state .icon { font-size: 2.5rem; margin-bottom: 10px; }
        .empty-state p { font-size: 0.9rem; }
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; }
        .settings-note { font-size: 0.78rem; color: var(--gray-500); margin-top: 4px; }
        .day-checks { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 4px; }
        .day-check { display: flex; align-items: center; gap: 3px; font-size: 0.8rem; }
        .day-check input { width: 16px; height: 16px; }
        .schedule-tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; }

        /* Print Schedule styles */
        .print-day { border: 1.5px solid var(--gray-200); border-radius: 8px; padding: 16px; margin-bottom: 12px; page-break-inside: avoid; }
        .print-day-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid var(--primary); }
        .print-day-header h3 { font-size: 1rem; color: var(--primary); }
        .print-day-header .print-day-date { font-size: 0.85rem; color: var(--gray-700); font-weight: 600; }
        .print-day table td, .print-day table th { padding: 6px 10px; font-size: 0.82rem; }
        .print-day .total-row { font-weight: 700; background: var(--primary-light); }

        /* ===== LIVE DISPLAY - TV ELECTION RESULTS STYLE ===== */
        /* Keyframes */
        @keyframes tvBgPan { 0%{background-position:0% 0%}50%{background-position:100% 100%}100%{background-position:0% 0%} }
        @keyframes tvScanline { 0%{top:-4px}100%{top:100%} }
        @keyframes tvShimmer { 0%{background-position:-200% center}100%{background-position:200% center} }
        @keyframes tvSlideRight { from{transform:translateX(-100%);opacity:0}to{transform:translateX(0);opacity:1} }
        @keyframes tvSlideLeft { from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1} }
        @keyframes tvSlideUp { from{transform:translateY(40px);opacity:0}to{transform:translateY(0);opacity:1} }
        @keyframes tvSlideDown { from{transform:translateY(-40px);opacity:0}to{transform:translateY(0);opacity:1} }
        @keyframes tvScaleIn { from{transform:scale(0.5);opacity:0}to{transform:scale(1);opacity:1} }
        @keyframes tvBarFill { from{width:0%} }
        @keyframes tvPulse { 0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.06);opacity:0.9} }
        @keyframes tvGlow { 0%,100%{box-shadow:0 0 10px rgba(200,162,61,0.3),inset 0 0 10px rgba(200,162,61,0.05)}50%{box-shadow:0 0 30px rgba(200,162,61,0.6),inset 0 0 20px rgba(200,162,61,0.1)} }
        @keyframes tvBlink { 0%,100%{opacity:1}50%{opacity:0.3} }
        @keyframes tvTicker { 0%{transform:translateX(100%)}100%{transform:translateX(-100%)} }
        @keyframes tvSweep { 0%{left:-30%;opacity:0}15%{opacity:0.6}50%{opacity:0.2}100%{left:130%;opacity:0} }
        @keyframes tvFloat { 0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)} }
        @keyframes tvRotateHue { 0%{filter:hue-rotate(0deg)}100%{filter:hue-rotate(360deg)} }
        @keyframes tvParticle { 0%{transform:translateY(100vh) rotate(0deg);opacity:0}10%{opacity:0.8}90%{opacity:0.8}100%{transform:translateY(-10vh) rotate(720deg);opacity:0} }
        @keyframes tvBreathing { 0%,100%{border-color:rgba(200,162,61,0.2)}50%{border-color:rgba(200,162,61,0.6)} }
        @keyframes tvFlash { 0%,10%,100%{opacity:0}5%{opacity:0.15} }
        @keyframes tvCounterBg { 0%,100%{background-position:0% 50%}50%{background-position:100% 50%} }
        @keyframes tvRowHighlight { 0%,100%{background:rgba(255,255,255,0.03)}50%{background:rgba(200,162,61,0.08)} }
        @keyframes tvLiveFlash { 0%,100%{box-shadow:0 0 6px #e74c3c}50%{box-shadow:0 0 20px #e74c3c,0 0 40px rgba(231,76,60,0.3)} }

        /* Base screen */
        .live-screen { background: linear-gradient(135deg, #0a0a1a, #0d1b2a, #1b2838, #0a0a1a); background-size: 400% 400%; color: #eee; padding: 0; min-height: 100vh; font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif; position: relative; overflow: hidden; animation: tvBgPan 40s ease infinite; }

        /* Scanline overlay */
        .live-screen::before { content:''; position:absolute; top:0; left:0; right:0; bottom:0; background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.03) 2px,rgba(0,0,0,0.03) 4px); pointer-events:none; z-index:10; }
        .live-screen::after { content:''; position:absolute; top:-4px; left:0; right:0; height:4px; background:rgba(255,255,255,0.03); animation:tvScanline 8s linear infinite; pointer-events:none; z-index:10; }

        /* Particles */
        .live-screen .live-particles { position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;overflow:hidden;z-index:0; }
        .live-screen .live-particle { position:absolute;background:rgba(200,162,61,0.4);border-radius:50%;animation:tvParticle linear infinite; }
        .live-screen > *:not(.live-particles) { position:relative;z-index:1; }

        /* Top bar - network style header */
        .live-screen .tv-topbar { display:flex; justify-content:space-between; align-items:center; padding:12px 30px; background:linear-gradient(90deg,rgba(200,162,61,0.15),transparent,rgba(200,162,61,0.15)); border-bottom:2px solid rgba(200,162,61,0.3); animation:tvSlideDown 0.6s ease-out both, tvBreathing 4s ease-in-out infinite; }
        .live-screen .tv-logo { font-size:1.6rem; font-weight:900; text-transform:uppercase; letter-spacing:3px; background:linear-gradient(90deg,#c8a23d,#f5e6a3,#c8a23d,#f5e6a3,#c8a23d); background-size:200% auto; -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; animation:tvShimmer 3s linear infinite; }
        .live-screen .tv-live-badge { background:#e74c3c; color:#fff; padding:4px 14px; border-radius:4px; font-size:0.75rem; font-weight:800; letter-spacing:2px; text-transform:uppercase; animation:tvLiveFlash 2s ease-in-out infinite; }
        .live-screen .tv-clock { font-size:1.1rem; font-weight:600; color:#c8a23d; font-variant-numeric:tabular-nums; letter-spacing:1px; }

        /* Main content area */
        .live-screen .tv-body { padding:16px 30px 0; }

        /* Day banner - breaking news style */
        .live-screen .tv-banner { position:relative; background:linear-gradient(135deg,#c8a23d,#e8c547,#daa520); padding:14px 30px; margin-bottom:16px; overflow:hidden; animation:tvSlideRight 0.8s ease-out 0.3s both; border-radius:4px; }
        .live-screen .tv-banner::after { content:''; position:absolute; top:0; left:-30%; width:30%; height:100%; background:linear-gradient(90deg,transparent,rgba(255,255,255,0.4),transparent); animation:tvSweep 4s ease-in-out infinite; }
        .live-screen .tv-banner h2 { color:#1a1a2e; font-size:1.6rem; font-weight:900; margin:0; text-transform:uppercase; letter-spacing:1px; }
        .live-screen .tv-banner .tv-banner-sub { color:rgba(26,26,46,0.7); font-size:0.95rem; font-weight:600; margin-top:2px; }

        /* Stats panels - big counter style */
        .live-screen .tv-stats { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:16px; }
        .live-screen .tv-stat-card { background:linear-gradient(180deg,rgba(255,255,255,0.08),rgba(255,255,255,0.02)); border:1px solid rgba(255,255,255,0.1); border-radius:8px; padding:14px; text-align:center; position:relative; overflow:hidden; animation:tvSlideUp 0.6s ease-out both; }
        .live-screen .tv-stat-card::after { content:''; position:absolute; top:0; left:-30%; width:30%; height:100%; background:linear-gradient(90deg,transparent,rgba(255,255,255,0.1),transparent); animation:tvSweep 6s ease-in-out infinite; }
        .live-screen .tv-stat-card:nth-child(1) { animation-delay:0.5s; }
        .live-screen .tv-stat-card:nth-child(2) { animation-delay:0.65s; }
        .live-screen .tv-stat-card:nth-child(3) { animation-delay:0.8s; }
        .live-screen .tv-stat-card:nth-child(4) { animation-delay:0.95s; }
        .live-screen .tv-stat-card:nth-child(1)::after { animation-delay:0s; }
        .live-screen .tv-stat-card:nth-child(2)::after { animation-delay:1.5s; }
        .live-screen .tv-stat-card:nth-child(3)::after { animation-delay:3s; }
        .live-screen .tv-stat-card:nth-child(4)::after { animation-delay:4.5s; }
        .live-screen .tv-stat-label { font-size:0.7rem; color:#8892b0; text-transform:uppercase; letter-spacing:1.5px; font-weight:700; margin-bottom:6px; }
        .live-screen .tv-stat-num { font-size:2rem; font-weight:900; font-variant-numeric:tabular-nums; animation:tvFloat 5s ease-in-out infinite; }
        .live-screen .tv-stat-num.gold { color:#c8a23d; text-shadow:0 0 20px rgba(200,162,61,0.4); }
        .live-screen .tv-stat-num.green { color:#2ecc71; text-shadow:0 0 20px rgba(46,204,113,0.4); }
        .live-screen .tv-stat-num.blue { color:#3498db; text-shadow:0 0 20px rgba(52,152,219,0.4); }
        .live-screen .tv-stat-card:nth-child(1) .tv-stat-num { animation-delay:0s; }
        .live-screen .tv-stat-card:nth-child(2) .tv-stat-num { animation-delay:1.2s; }
        .live-screen .tv-stat-card:nth-child(3) .tv-stat-num { animation-delay:2.4s; }

        /* Status badge */
        .live-screen .tv-status { display:inline-block; padding:5px 16px; border-radius:4px; font-size:0.85rem; font-weight:800; text-transform:uppercase; letter-spacing:2px; }
        .live-screen .tv-status.pending, .live-screen .tv-status.scheduled { background:rgba(241,196,15,0.2); color:#f1c40f; animation:tvPulse 2s ease-in-out infinite; }
        .live-screen .tv-status.cooking { background:rgba(230,81,0,0.2); color:#e65100; animation:tvPulse 2s ease-in-out infinite; }
        .live-screen .tv-status.cooked { background:rgba(46,204,113,0.2); color:#2ecc71; animation:tvPulse 2s ease-in-out infinite; }
        .live-screen .tv-status.distributed { background:rgba(52,152,219,0.2); color:#3498db; animation:tvPulse 2s ease-in-out infinite; }
        .live-screen .tv-status.reported { background:rgba(123,31,162,0.2); color:#7b1fa2; animation:tvPulse 2s ease-in-out infinite; }

        /* Progress bar */
        .live-screen .tv-progress { margin-bottom:16px; animation:tvSlideUp 0.6s ease-out 1.1s both; }
        .live-screen .tv-progress-info { display:flex; justify-content:space-between; font-size:0.75rem; color:#8892b0; margin-bottom:4px; text-transform:uppercase; letter-spacing:1px; font-weight:600; }
        .live-screen .tv-progress-bar { background:rgba(255,255,255,0.08); border-radius:6px; height:20px; overflow:hidden; position:relative; border:1px solid rgba(255,255,255,0.1); }
        .live-screen .tv-progress-fill { height:100%; border-radius:5px; background:linear-gradient(90deg,#c8a23d,#2ecc71,#c8a23d); background-size:200% 100%; animation:tvBarFill 2s ease-out 1.3s both, tvShimmer 2s linear infinite; position:relative; }
        .live-screen .tv-progress-fill::after { content:''; position:absolute; right:0; top:0; bottom:0; width:4px; background:#fff; border-radius:2px; animation:tvBlink 1s ease-in-out infinite; }
        .live-screen .tv-progress-pct { position:absolute; right:8px; top:50%; transform:translateY(-50%); font-size:0.7rem; font-weight:800; color:#fff; text-shadow:0 1px 3px rgba(0,0,0,0.5); }

        /* Organization bars - election bar chart style */
        .live-screen .tv-org-bars { margin-bottom:14px; }
        .live-screen .tv-org-bar-row { display:flex; align-items:center; margin-bottom:6px; animation:tvSlideRight 0.6s ease-out both; position:relative; }
        .live-screen .tv-org-bar-row::after { content:''; position:absolute; top:0; left:0; right:0; bottom:0; animation:tvRowHighlight 8s ease-in-out infinite; border-radius:6px; pointer-events:none; z-index:0; }
        .live-screen .tv-org-name { width:130px; min-width:130px; font-size:0.8rem; font-weight:700; color:#eee; padding-right:10px; text-align:right; z-index:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .live-screen .tv-org-bar-wrap { flex:1; height:28px; background:rgba(255,255,255,0.05); border-radius:4px; overflow:hidden; position:relative; z-index:1; border:1px solid rgba(255,255,255,0.06); }
        .live-screen .tv-org-bar-fill { height:100%; border-radius:3px; display:flex; align-items:center; justify-content:flex-end; padding-right:10px; animation:tvBarFill 1.5s ease-out both; position:relative; overflow:hidden; min-width:fit-content; }
        .live-screen .tv-org-bar-fill::after { content:''; position:absolute; top:0; left:-30%; width:30%; height:100%; background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent); animation:tvSweep 5s ease-in-out infinite; }
        .live-screen .tv-org-bar-qty { font-size:0.75rem; font-weight:800; color:#fff; text-shadow:0 1px 3px rgba(0,0,0,0.5); z-index:1; padding:0 8px; white-space:nowrap; }
        .live-screen .tv-org-details { display:flex; gap:12px; margin-left:10px; z-index:1; }
        .live-screen .tv-org-detail { font-size:0.65rem; color:#8892b0; white-space:nowrap; }
        .live-screen .tv-org-detail span { color:#ccc; font-weight:600; }

        /* Bottom info row */
        .live-screen .tv-bottom { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:8px; }
        .live-screen .tv-bottom-card { background:linear-gradient(180deg,rgba(255,255,255,0.06),rgba(255,255,255,0.02)); border:1px solid rgba(255,255,255,0.08); border-radius:6px; padding:10px 14px; animation:tvSlideUp 0.5s ease-out both, tvGlow 6s ease-in-out infinite; }
        .live-screen .tv-bottom-card:nth-child(1) { animation-delay:1.6s,3s; }
        .live-screen .tv-bottom-card:nth-child(2) { animation-delay:1.75s,4.5s; }
        .live-screen .tv-bottom-card:nth-child(3) { animation-delay:1.9s,6s; }
        .live-screen .tv-bottom-label { font-size:0.65rem; color:#8892b0; text-transform:uppercase; letter-spacing:1.5px; font-weight:700; }
        .live-screen .tv-bottom-val { font-size:1.1rem; font-weight:800; color:#eee; margin-top:2px; font-variant-numeric:tabular-nums; }

        /* Ticker */
        .live-screen .tv-ticker-wrap { background:linear-gradient(90deg,#c8a23d,#daa520); padding:6px 0; overflow:hidden; position:relative; }
        .live-screen .tv-ticker-label { position:absolute; left:0; top:0; bottom:0; background:#1a1a2e; color:#c8a23d; font-size:0.7rem; font-weight:800; padding:6px 14px; z-index:2; display:flex; align-items:center; text-transform:uppercase; letter-spacing:1px; border-right:3px solid #c8a23d; }
        .live-screen .tv-ticker-content { display:flex; animation:tvTicker 30s linear infinite; white-space:nowrap; padding-left:120px; }
        .live-screen .tv-ticker-item { color:#1a1a2e; font-size:0.75rem; font-weight:700; padding:0 30px; }
        .live-screen .tv-ticker-dot { color:rgba(26,26,46,0.4); padding:0 4px; }

        /* Flash overlay for anti burn-in */
        .live-screen .tv-flash { position:absolute; top:0; left:0; right:0; bottom:0; background:rgba(255,255,255,0.15); pointer-events:none; z-index:5; animation:tvFlash 30s ease-in-out infinite; }

        /* Notes */
        .live-screen .tv-notes { background:rgba(255,255,255,0.04); border-left:3px solid #c8a23d; padding:8px 14px; margin-bottom:14px; border-radius:0 6px 6px 0; animation:tvSlideRight 0.5s ease-out 1.5s both; }
        .live-screen .tv-notes-label { font-size:0.65rem; color:#c8a23d; text-transform:uppercase; letter-spacing:1px; font-weight:700; }
        .live-screen .tv-notes-text { font-size:0.85rem; color:#ccc; margin-top:2px; }

        /* Recent updates on live display */
        /* Live display updates - 4-card grid */
        .live-screen .tv-updates { margin-bottom:10px; }
        .live-screen .tv-updates-title { font-size:0.7rem; color:#c8a23d; text-transform:uppercase; letter-spacing:2px; font-weight:800; margin-bottom:10px; display:flex; align-items:center; gap:8px; }
        .live-screen .tv-updates-title::after { content:''; flex:1; height:1px; background:rgba(200,162,61,0.3); }
        .live-screen .tv-updates-grid { display:grid; grid-template-columns:repeat(6,1fr); gap:8px; }
        .live-screen .tv-ucard { background:rgba(255,255,255,0.05); border-radius:10px; overflow:hidden; border:1px solid rgba(255,255,255,0.08); animation:tvSlideUp 0.5s ease-out both; position:relative; }
        .live-screen .tv-ucard::after { content:''; position:absolute; top:0; left:-30%; width:30%; height:100%; background:linear-gradient(90deg,transparent,rgba(255,255,255,0.08),transparent); animation:tvSweep 7s ease-in-out infinite; pointer-events:none; }
        /* Photo card */
        .live-screen .tv-ucard-photo { width:100%; height:110px; object-fit:cover; display:block; }
        .live-screen .tv-ucard-body { padding:8px 10px; }
        .live-screen .tv-ucard-top { display:flex; align-items:center; gap:5px; margin-bottom:4px; }
        .live-screen .tv-ucard-name { font-weight:700; font-size:0.7rem; color:#eee; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .live-screen .tv-ucard-badge { font-size:0.5rem; padding:1px 5px; border-radius:6px; font-weight:700; text-transform:uppercase; flex-shrink:0; }
        .live-screen .tv-ucard-badge.cooking { background:rgba(46,204,113,0.2); color:#2ecc71; }
        .live-screen .tv-ucard-badge.distribution { background:rgba(52,152,219,0.2); color:#3498db; }
        .live-screen .tv-ucard-badge.issue { background:rgba(231,76,60,0.2); color:#e74c3c; }
        .live-screen .tv-ucard-badge.general { background:rgba(200,162,61,0.2); color:#c8a23d; }
        .live-screen .tv-ucard-msg { font-size:0.7rem; color:#999; line-height:1.3; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; }
        .live-screen .tv-ucard-time { font-size:0.55rem; color:#4a5568; margin-top:4px; }
        /* Text-only card has more padding */
        .live-screen .tv-ucard-text-icon { font-size:1.5rem; text-align:center; padding:10px 0 4px; opacity:0.4; }

        /* Footer */
        .live-screen .tv-footer { text-align:center; padding:6px; font-size:0.65rem; color:#4a5568; letter-spacing:1px; }

        /* ===== UPDATES PAGE - MOBILE APP STYLE ===== */
        #page-updates { position:relative; padding-bottom:140px; }

        /* Sticky compose bar - WhatsApp style at bottom */
        .upd-compose { position:fixed; bottom:0; left:0; right:0; z-index:90; background:white; border-top:1px solid var(--gray-100); padding:0; box-shadow:0 -4px 20px rgba(0,0,0,0.08); display:flex; flex-direction:column; }
        .upd-compose-expanded { max-height:70vh; overflow-y:auto; }
        .upd-compose-top { display:flex; align-items:flex-end; gap:8px; padding:10px 14px; }
        .upd-compose-avatar { width:36px; height:36px; min-width:36px; border-radius:50%; background:var(--primary); color:white; display:flex; align-items:center; justify-content:center; font-weight:800; font-size:0.85rem; text-transform:uppercase; margin-bottom:4px; }
        .upd-compose-inputs { flex:1; min-width:0; background:var(--gray-50); border-radius:20px; padding:8px 14px; border:1.5px solid var(--gray-100); transition:border-color 0.2s; }
        .upd-compose-inputs:focus-within { border-color:var(--primary); background:white; }
        .upd-name-input { border:none; font-size:0.78rem; font-weight:700; padding:0; width:100%; outline:none; color:var(--primary); background:transparent; margin-bottom:2px; }
        .upd-name-input::placeholder { color:var(--gray-300); font-weight:500; }
        .upd-msg-input { border:none; font-size:0.88rem; padding:0; width:100%; outline:none; resize:none; color:var(--gray-800); line-height:1.4; font-family:inherit; min-height:22px; max-height:80px; background:transparent; }
        .upd-msg-input::placeholder { color:var(--gray-300); }
        .upd-send-btn { width:40px; height:40px; min-width:40px; border-radius:50%; background:var(--primary); color:white; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.2s; box-shadow:0 2px 8px rgba(26,107,74,0.3); margin-bottom:4px; }
        .upd-send-btn:hover { background:var(--primary-dark); transform:scale(1.05); }
        .upd-send-btn:active { transform:scale(0.9); }

        /* Compose extras row */
        .upd-compose-extras { display:flex; align-items:center; gap:4px; padding:0 14px 10px; }
        .upd-action-btn { cursor:pointer; color:var(--gray-400); padding:8px; border-radius:50%; transition:all 0.2s; display:flex; align-items:center; background:none; border:none; }
        .upd-action-btn:hover { background:var(--primary-light); color:var(--primary); }
        .upd-tag-row { display:flex; gap:4px; flex:1; overflow-x:auto; -webkit-overflow-scrolling:touch; }
        .upd-tag-select { border:1.5px solid var(--gray-100); border-radius:20px; padding:4px 10px; font-size:0.7rem; font-weight:600; color:var(--gray-500); background:white; outline:none; cursor:pointer; -webkit-appearance:none; appearance:none; white-space:nowrap; }
        .upd-tag-select:focus { border-color:var(--primary); color:var(--primary); }

        /* Photo preview in compose */
        .upd-photo-preview { position:relative; display:block; padding:4px 14px 8px; }
        .upd-photo-preview-img { max-width:100%; max-height:140px; border-radius:12px; border:1px solid var(--gray-100); display:block; }
        .upd-photo-remove { position:absolute; top:8px; right:18px; width:26px; height:26px; border-radius:50%; background:rgba(0,0,0,0.6); color:white; border:none; font-size:1.1rem; cursor:pointer; display:flex; align-items:center; justify-content:center; line-height:1; backdrop-filter:blur(4px); }

        /* Filter pills at top */
        .upd-filters { display:flex; gap:6px; padding:2px 0 12px; overflow-x:auto; -webkit-overflow-scrolling:touch; }
        .upd-filter-pill { padding:6px 16px; border-radius:20px; font-size:0.78rem; font-weight:600; border:1.5px solid var(--gray-200); background:white; color:var(--gray-500); cursor:pointer; white-space:nowrap; transition:all 0.2s; }
        .upd-filter-pill.active { background:var(--primary); color:white; border-color:var(--primary); }
        .upd-filter-pill:hover:not(.active) { border-color:var(--primary); color:var(--primary); }

        /* ===== UPDATES - FEED CARDS (Instagram style) ===== */
        .updates-feed-wrap { }
        .upd-feed-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
        .upd-feed-count { font-size:0.75rem; color:var(--gray-400); font-weight:500; }
        .upd-feed-clear { font-size:0.72rem; color:#e74c3c; background:none; border:1px solid #fdd; padding:4px 12px; border-radius:20px; cursor:pointer; font-weight:600; transition:all 0.2s; }
        .upd-feed-clear:hover { background:#fff0f0; }

        .update-card { background:white; border-radius:14px; overflow:hidden; margin-bottom:10px; position:relative; box-shadow:0 1px 4px rgba(0,0,0,0.06); transition:all 0.25s; border:1px solid var(--gray-100); }
        .update-card.type-cooking { border-left:3px solid #2ecc71; }
        .update-card.type-distribution { border-left:3px solid #3498db; }
        .update-card.type-issue { border-left:3px solid #e74c3c; }
        .update-card.type-general { border-left:3px solid #c8a23d; }

        .update-card-header { display:flex; align-items:center; gap:10px; padding:12px 14px 0; }
        .update-card-avatar { width:36px; height:36px; min-width:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:800; font-size:0.8rem; text-transform:uppercase; color:white; }
        .update-card-info { flex:1; min-width:0; }
        .update-staff { font-weight:700; font-size:0.88rem; color:var(--gray-900); display:block; line-height:1.2; }
        .update-meta-row { display:flex; align-items:center; gap:6px; margin-top:2px; }
        .update-type-badge { font-size:0.58rem; font-weight:700; padding:2px 8px; border-radius:10px; text-transform:uppercase; letter-spacing:0.4px; }
        .update-type-badge.cooking { background:#e8f8f0; color:#27ae60; }
        .update-type-badge.distribution { background:#eaf2fa; color:#2980b9; }
        .update-type-badge.issue { background:#fdeaea; color:#c0392b; }
        .update-type-badge.general { background:#fdf6e3; color:#b8860b; }
        .update-day-badge { font-size:0.62rem; color:var(--gray-500); background:var(--gray-50); padding:2px 7px; border-radius:8px; font-weight:600; }
        .update-time { font-size:0.68rem; color:var(--gray-400); }
        .update-card-actions { display:flex; align-items:center; }
        .update-delete { background:none; border:none; color:var(--gray-300); cursor:pointer; padding:8px; border-radius:50%; transition:all 0.2s; display:flex; align-items:center; }
        .update-delete:hover { color:#e74c3c; background:rgba(231,76,60,0.08); }

        .update-message { font-size:0.88rem; color:var(--gray-700); line-height:1.55; padding:8px 14px; white-space:pre-wrap; word-break:break-word; }
        .update-photo-thumb { width:100%; max-height:340px; object-fit:cover; cursor:pointer; transition:opacity 0.2s; display:block; }
        .update-photo-thumb:active { opacity:0.85; }

        .update-card-footer { display:flex; align-items:center; gap:10px; padding:8px 14px 10px; border-top:1px solid var(--gray-50); }
        .update-reactions { display:flex; gap:2px; }
        .update-react-btn { background:none; border:none; font-size:1.1rem; cursor:pointer; padding:4px 6px; border-radius:8px; transition:all 0.15s; opacity:0.5; }
        .update-react-btn:hover { opacity:1; transform:scale(1.2); }
        .update-react-btn.reacted { opacity:1; }

        .update-empty { text-align:center; padding:60px 20px; color:var(--gray-300); }
        .update-empty-icon { font-size:3rem; margin-bottom:10px; opacity:0.4; }
        .update-empty-text { font-size:0.9rem; }
        .update-empty-sub { font-size:0.78rem; color:var(--gray-300); margin-top:4px; }

        /* Photo lightbox */
        .photo-lightbox { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.95); z-index:9999; display:flex; align-items:center; justify-content:center; cursor:pointer; animation:lbFadeIn 0.2s ease; }
        .photo-lightbox img { max-width:96vw; max-height:94vh; border-radius:4px; box-shadow:0 8px 40px rgba(0,0,0,0.5); }
        @keyframes lbFadeIn { from{opacity:0} to{opacity:1} }

        @media print {
            .header, .nav-tabs, .no-print, .upd-compose { display: none !important; }
            .main { padding: 0; max-width: 100%; }
            .page { display: none !important; }
            .page.print-target { display: block !important; }
            .card { box-shadow: none; border: 1px solid #ddd; }
            body { background: white; font-size: 11pt; }
            .print-day { border: 1px solid #ccc; page-break-inside: avoid; }
            .print-day-header { border-bottom: 2px solid #333; }
            .print-day-header h3 { color: #333; }
            /* Org schedule print */
            .print-org-schedule { display: flex !important; }
            .print-org-schedule .modal { width: 100%; max-width: 100%; box-shadow: none; max-height: none; }
            .print-org-schedule .modal-close, .print-org-schedule .btn { display: none !important; }
            .print-org-schedule .stat-card { box-shadow: none; border: 1px solid #ddd; }
        }

        @media (max-width: 768px) {
            /* Layout */
            .main { padding: 10px; }
            .card { padding: 14px; margin-bottom: 10px; border-radius: 10px; }
            .card-title { font-size: 0.92rem; margin-bottom: 12px; justify-content: center; text-align: center; gap: 6px; }
            .card-title > div { width: 100%; display: flex; justify-content: center; gap: 6px; flex-wrap: wrap; }
            /* Stats */
            .stat-card { padding: 12px 14px; text-align: center; border-left-width: 3px; }
            .stat-value { font-size: 1.3rem; }
            .stat-label { font-size: 0.7rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 14px; }
            /* Forms */
            .form-row { flex-direction: column; gap: 8px; margin-bottom: 8px; }
            .form-group { min-width: 100%; }
            .form-group input, .form-group select, .form-group textarea { font-size: 0.88rem; }
            /* Header & Nav */
            .header h1 { font-size: 1.1rem; }
            .header { padding: 12px 14px; }
            .nav-tabs { padding: 0 6px; gap: 0; }
            .nav-tab { padding: 12px 12px; font-size: 0.82rem; }
            /* Grids */
            .days-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; }
            .settings-grid { grid-template-columns: 1fr; gap: 10px; }
            /* Tables */
            .table-wrap { margin: 0 -14px; padding: 0 14px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
            th, td { padding: 8px 10px; font-size: 0.8rem; }
            th { font-size: 0.68rem; }
            /* Buttons */
            .btn { padding: 8px 14px; font-size: 0.82rem; }
            .btn-sm { padding: 5px 10px; font-size: 0.75rem; }
            .header-right { display: none; }
            /* Alerts */
            .alert { font-size: 0.8rem; padding: 10px 12px; text-align: center; justify-content: center; }
            /* Modal */
            .modal { width: 95%; padding: 18px; }
            /* Empty state */
            .empty-state { padding: 30px 16px; }
            /* Updates mobile */
            #page-updates { padding-bottom:130px; margin:0 -10px; }
            .upd-compose-top { padding:8px 12px; gap:6px; }
            .upd-compose-avatar { width:32px; height:32px; min-width:32px; font-size:0.75rem; }
            .upd-compose-inputs { padding:6px 12px; border-radius:18px; }
            .upd-name-input { font-size:0.72rem; }
            .upd-msg-input { font-size:0.85rem; }
            .upd-send-btn { width:36px; height:36px; min-width:36px; }
            .upd-compose-extras { padding:0 12px 8px; gap:2px; }
            .upd-tag-select { font-size:0.65rem; padding:3px 8px; }
            .upd-photo-preview { padding:2px 12px 6px; }
            .upd-photo-preview-img { max-height:120px; }
            .update-card { border-radius:0; margin-bottom:1px; border-left-width:3px; border:none; border-bottom:1px solid var(--gray-100); }
            .update-card.type-cooking { border-left:3px solid #2ecc71; }
            .update-card.type-distribution { border-left:3px solid #3498db; }
            .update-card.type-issue { border-left:3px solid #e74c3c; }
            .update-card.type-general { border-left:3px solid #c8a23d; }
            .update-card-header { padding:10px 12px 0; gap:8px; }
            .update-card-avatar { width:32px; height:32px; min-width:32px; font-size:0.7rem; }
            .update-staff { font-size:0.84rem; }
            .update-message { padding:6px 12px; font-size:0.84rem; }
            .update-photo-thumb { max-height:260px; }
            .update-card-footer { padding:6px 12px 8px; }
            .update-time { font-size:0.65rem; }
            .upd-filters { padding:2px 10px 10px; }
            .upd-filter-pill { padding:5px 12px; font-size:0.72rem; }
            .upd-feed-header { padding:0 10px; }
            /* Print day cards */
            .print-day { padding: 12px; margin-bottom: 8px; }
            .print-day-header h3 { font-size: 0.9rem; }
        }
        @media (max-width: 480px) {
            .main { padding: 6px; }
            .card { padding: 10px; border-radius: 8px; margin-bottom: 8px; }
            .card-title { font-size: 0.88rem; margin-bottom: 10px; }
            .stat-card { padding: 10px; }
            .stat-value { font-size: 1.15rem; }
            .stat-label { font-size: 0.65rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 6px; margin-bottom: 10px; }
            .nav-tabs { padding: 0 2px; }
            .nav-tab { padding: 10px 8px; font-size: 0.75rem; }
            .days-grid { grid-template-columns: repeat(2, 1fr); gap: 6px; }
            .day-card { padding: 10px; }
            .day-card .day-num { font-size: 0.9rem; }
            .modal { width: 96%; padding: 14px; }
            #page-updates { margin:0 -6px; }
            .upd-compose-top { padding:6px 10px; }
            .upd-compose-extras { padding:0 10px 6px; }
            .upd-compose-avatar { width:28px; height:28px; min-width:28px; font-size:0.7rem; }
            .upd-compose-inputs { padding:5px 10px; }
            .upd-send-btn { width:34px; height:34px; min-width:34px; }
            .update-card-header { padding:8px 10px 0; }
            .update-message { padding:6px 10px; }
            .update-card-footer { padding:4px 10px 8px; }
            .upd-filter-pill { padding:4px 10px; font-size:0.68rem; }
            .alert { font-size: 0.78rem; padding: 8px 10px; }
            th, td { padding: 6px 8px; font-size: 0.75rem; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <div class="header-logo" id="header-logo"></div>
            <div>
                <h1 id="header-title"></h1>
                <div class="subtitle" id="header-subtitle"></div>
            </div>
        </div>
        <div class="header-right no-print">
            <button class="btn btn-outline" style="color:white;border-color:rgba(255,255,255,0.5);background:rgba(255,255,255,0.1);font-weight:600" onclick="exportData()">Export</button>
            <button class="btn btn-outline" style="color:white;border-color:rgba(255,255,255,0.5);background:rgba(255,255,255,0.1);font-weight:600" onclick="importDataPrompt()">Import</button>
        </div>
    </div>

    <div class="nav-tabs no-print" id="navTabs">
        <div class="nav-tab active" data-page="dashboard">Dashboard</div>
        <div class="nav-tab" data-page="organizations">Organizations</div>
        <div class="nav-tab" data-page="daily-plan">Daily Plan</div>
        <div class="nav-tab" data-page="schedule">Daily Schedule</div>
        <div class="nav-tab" data-page="distribution">Distribution Log</div>
        <div class="nav-tab" data-page="reports">Reports</div>
        <div class="nav-tab" data-page="updates">Updates</div>
        <div class="nav-tab" data-page="live-display">Live Display</div>
        <div class="nav-tab" data-page="settings">Settings</div>
    </div>

    <div class="main">
        <!-- DASHBOARD -->
        <div class="page active" id="page-dashboard">
            <div id="alerts-container"></div>
            <div id="dashboard-today"></div>
            <div class="stats-grid" id="dashboard-stats"></div>
            <div class="card">
                <div class="card-title" id="capacity-chart-title"></div>
                <div id="capacity-chart"></div>
            </div>
            <div class="card">
                <div class="card-title">Organization Contributions</div>
                <div class="table-wrap">
                    <table id="dashboard-org-table">
                        <thead><tr><th>Organization</th><th>Meals</th><th>Schedule</th><th>Min/Day</th><th>% of Total</th><th>Days Covered</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ORGANIZATIONS -->
        <div class="page" id="page-organizations">
            <div class="card">
                <div class="card-title">Add Organization</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Organization Name</label>
                        <input type="text" id="orgName" placeholder="Organization name">
                    </div>
                    <div class="form-group">
                        <label>Total Meals</label>
                        <input type="number" id="orgQty" placeholder="Total meals" min="1">
                    </div>
                    <div class="form-group">
                        <label>Min Meals / Day</label>
                        <input type="number" id="orgMinPerDay" value="100" min="1" placeholder="100">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Schedule Type</label>
                        <select id="orgScheduleType" onchange="toggleDayChecks()">
                            <option value="daily">Every Day</option>
                            <option value="alternate">Every Other Day</option>
                            <option value="weekly">Specific Day(s) of Week</option>
                            <option value="weekly-total">Weekly Total (system splits)</option>
                            <option value="auto">Auto (system decides)</option>
                        </select>
                    </div>
                    <div class="form-group" id="weeklyDaysGroup" style="display:none">
                        <label>Select Day(s)</label>
                        <div class="day-checks" id="orgWeeklyDays">
                            <label class="day-check"><input type="checkbox" value="0"> Sun</label>
                            <label class="day-check"><input type="checkbox" value="1"> Mon</label>
                            <label class="day-check"><input type="checkbox" value="2"> Tue</label>
                            <label class="day-check"><input type="checkbox" value="3"> Wed</label>
                            <label class="day-check"><input type="checkbox" value="4"> Thu</label>
                            <label class="day-check"><input type="checkbox" value="5"> Fri</label>
                            <label class="day-check"><input type="checkbox" value="6"> Sat</label>
                        </div>
                    </div>
                    <div class="form-group" id="weeklyTotalGroup" style="display:none">
                        <label>Meals Per Week</label>
                        <input type="number" id="orgWeeklyTotal" placeholder="e.g. 500" min="1">
                        <div class="settings-note">System will split into rounded daily amounts</div>
                    </div>
                    <div class="form-group">
                        <label>Contact Person</label>
                        <input type="text" id="orgContact" placeholder="Optional">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="text" id="orgPhone" placeholder="Optional">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <input type="text" id="orgNotes" placeholder="Optional">
                    </div>
                    <div class="form-group" style="display:flex;align-items:flex-end;justify-content:center">
                        <button class="btn btn-primary" style="width:100%" onclick="addOrganization()">+ Add Organization</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">
                    <span>Registered Organizations</span>
                    <span id="org-count" style="font-size:0.8rem;color:var(--gray-500)"></span>
                </div>
                <div class="table-wrap">
                    <table id="org-table">
                        <thead><tr><th></th><th>Organization</th><th>Total Meals</th><th>Schedule</th><th>Min/Day</th><th>Contact</th><th>Phone</th><th>Actions</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div id="org-empty" class="empty-state" style="display:none">
                    <div class="icon">&#127781;</div>
                    <p>No organizations added yet. Add your first Ifthar project above.</p>
                </div>
            </div>
        </div>

        <!-- DAILY PLAN -->
        <div class="page" id="page-daily-plan">
            <div class="card">
                <div class="card-title">
                    <span id="daily-plan-title"></span>
                    <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:center">
                        <button class="btn btn-sm btn-primary" onclick="autoSchedule()">Auto-Schedule</button>
                    </div>
                </div>
                <p style="font-size:0.82rem;color:var(--gray-500);margin-bottom:14px" id="daily-plan-desc"></p>
                <div class="days-grid" id="days-grid"></div>
            </div>
        </div>

        <!-- DAILY SCHEDULE (Printable) -->
        <div class="page" id="page-schedule">
            <div class="card no-print">
                <div class="card-title">
                    <span>Daily Schedule</span>
                    <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:center">
                        <button class="btn btn-sm btn-outline" onclick="printSingleDay()">Print Single Day</button>
                        <button class="btn btn-sm btn-primary" onclick="printOrgWiseSchedule()">Org Schedule</button>
                        <button class="btn btn-sm btn-accent" onclick="printSchedule()">Print Full Schedule</button>
                    </div>
                </div>
                <p style="font-size:0.82rem;color:var(--gray-500);margin-bottom:14px">
                    Printable daily schedule showing each day's meal allocation by organization.
                </p>
            </div>
            <div id="schedule-content"></div>
        </div>

        <!-- DISTRIBUTION LOG -->
        <div class="page" id="page-distribution">
            <div class="card">
                <div class="card-title">Daily Distribution Log</div>
                <div class="table-wrap">
                    <table id="dist-table">
                        <thead><tr><th>Day</th><th>Date</th><th>Organizations / Staff / Location</th><th>Planned</th><th>Cooked</th><th>Distributed</th><th>Status</th><th>Actions</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- REPORTS -->
        <div class="page" id="page-reports">
            <div class="card">
                <div class="card-title">
                    <span id="report-title"></span>
                    <button class="btn btn-sm btn-primary no-print" onclick="printReport()">Print Report</button>
                </div>
                <div id="report-content"></div>
            </div>
        </div>

        <!-- UPDATES -->
        <div class="page" id="page-updates">
            <!-- Filter pills -->
            <div class="upd-filters" id="updFilters">
                <button class="upd-filter-pill active" data-filter="all" onclick="filterUpdates('all',this)">All</button>
                <button class="upd-filter-pill" data-filter="cooking" onclick="filterUpdates('cooking',this)">Cooking</button>
                <button class="upd-filter-pill" data-filter="distribution" onclick="filterUpdates('distribution',this)">Distribution</button>
                <button class="upd-filter-pill" data-filter="issue" onclick="filterUpdates('issue',this)">Issues</button>
                <button class="upd-filter-pill" data-filter="general" onclick="filterUpdates('general',this)">General</button>
            </div>
            <!-- Feed -->
            <div id="updates-feed" class="updates-feed-wrap"></div>
            <!-- Sticky compose bar at bottom -->
            <div class="upd-compose" id="updCompose">
                <div id="updatePhotoPreview" class="upd-photo-preview" style="display:none">
                    <img id="updatePhotoImg" class="upd-photo-preview-img">
                    <button class="upd-photo-remove" onclick="clearUpdatePhoto()">&times;</button>
                </div>
                <div class="upd-compose-top">
                    <div class="upd-compose-avatar" id="updAvatar">?</div>
                    <div class="upd-compose-inputs">
                        <input type="text" id="updateStaff" class="upd-name-input" placeholder="Your name">
                        <textarea id="updateMessage" class="upd-msg-input" placeholder="Share an update..." rows="1"></textarea>
                    </div>
                    <button class="upd-send-btn" onclick="postUpdate()">
                        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2Z"/></svg>
                    </button>
                </div>
                <div class="upd-compose-extras">
                    <label class="upd-action-btn" title="Photo">
                        <input type="file" id="updatePhoto" accept="image/*" style="display:none" onchange="previewUpdatePhoto(this)">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="3"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                    </label>
                    <label class="upd-action-btn" title="Camera" onclick="document.getElementById('updatePhoto').setAttribute('capture','environment');document.getElementById('updatePhoto').click();">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>
                    </label>
                    <div class="upd-tag-row">
                        <select id="updateType" class="upd-tag-select">
                            <option value="general">General</option>
                            <option value="cooking">Cooking</option>
                            <option value="distribution">Distribution</option>
                            <option value="issue">Issue</option>
                        </select>
                        <select id="updateDay" class="upd-tag-select"></select>
                    </div>
                </div>
            </div>
        </div>

        <!-- LIVE DISPLAY -->
        <div class="page" id="page-live-display">
            <div class="card no-print">
                <div class="card-title">
                    <span>Live Display - Second Monitor</span>
                    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:center">
                        <select id="liveDaySelect" onchange="renderLiveDisplay()" style="padding:6px 10px;border:1.5px solid var(--gray-200);border-radius:6px;font-size:0.85rem"></select>
                        <button class="btn btn-sm btn-accent" onclick="openLiveDisplayWindow()">Open in New Window</button>
                        <button class="btn btn-sm btn-primary" onclick="enterFullscreen()">Go Fullscreen</button>
                    </div>
                </div>
                <p style="font-size:0.82rem;color:var(--gray-500);margin-bottom:14px">
                    Select a day and view its full details. Open in a new window and drag to your second monitor. Auto-refreshes every 10 seconds.
                </p>
            </div>
            <div id="live-display-preview" style="background:#1a1a2e;border-radius:var(--radius);overflow:hidden;min-height:400px"></div>
        </div>

        <!-- SETTINGS -->
        <div class="page" id="page-settings">
            <div class="card">
                <div class="card-title">Project Settings</div>
                <p style="font-size:0.82rem;color:var(--gray-500);margin-bottom:16px">Configure your project details.</p>
                <div class="settings-grid">
                    <div class="form-group">
                        <label>Organization / Project Name</label>
                        <input type="text" id="settingOrgName">
                        <div class="settings-note">Shown in header and reports</div>
                    </div>
                    <div class="form-group">
                        <label>Daily Cooking Capacity (Meals)</label>
                        <input type="number" id="settingCapacity" min="1">
                        <div class="settings-note">Maximum meals per day</div>
                    </div>
                    <div class="form-group">
                        <label>Total Fasting Days</label>
                        <input type="number" id="settingTotalDays" min="1" max="60">
                    </div>
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="date" id="settingStartDate">
                    </div>
                </div>
                <div style="margin-top:20px;display:flex;gap:10px;flex-wrap:wrap;justify-content:center">
                    <button class="btn btn-primary" style="flex:1;min-width:140px" onclick="saveSettings()">Save Settings</button>
                </div>
            </div>
            <div class="card">
                <div class="card-title">
                    <span>Auto Backups</span>
                    <button class="btn btn-sm btn-outline" onclick="loadBackups()">Refresh</button>
                </div>
                <p style="font-size:0.82rem;color:var(--gray-500);margin-bottom:12px">Backups are created automatically every time data is saved. Last 20 backups are kept.</p>
                <div id="backups-list" style="font-size:0.85rem;color:var(--gray-500);text-align:center;padding:12px">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Day Detail Modal -->
    <div class="modal-overlay" id="dayModal">
        <div class="modal">
            <div class="modal-title">
                <span id="modal-day-title"></span>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modal-day-body"></div>
        </div>
    </div>

    <!-- Edit Org Modal -->
    <div class="modal-overlay" id="editOrgModal">
        <div class="modal">
            <div class="modal-title">
                <span>Edit Organization</span>
                <button class="modal-close" onclick="closeEditOrgModal()">&times;</button>
            </div>
            <div id="edit-org-body"></div>
        </div>
    </div>

    <!-- Setup Modal -->
    <div class="modal-overlay" id="setupModal">
        <div class="modal">
            <div class="modal-title"><span>Welcome! Set Up Your Ifthar Project</span></div>
            <p style="font-size:0.85rem;color:var(--gray-500);margin-bottom:16px">Configure your project to get started. You can change these later in Settings.</p>
            <div class="form-group" style="margin-bottom:12px">
                <label>Organization / Project Name</label>
                <input type="text" id="setupOrgName" placeholder="Your organization name">
            </div>
            <div class="form-group" style="margin-bottom:12px">
                <label>Daily Cooking Capacity (Meals)</label>
                <input type="number" id="setupCapacity" min="1" placeholder="e.g. 1000">
            </div>
            <div class="form-group" style="margin-bottom:12px">
                <label>Total Fasting Days</label>
                <input type="number" id="setupTotalDays" min="1" max="60" value="30">
            </div>
            <div class="form-group" style="margin-bottom:16px">
                <label>Start Date</label>
                <input type="date" id="setupStartDate">
            </div>
            <div style="display:flex;justify-content:flex-end">
                <button class="btn btn-primary" onclick="completeSetup()">Get Started</button>
            </div>
        </div>
    </div>

    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">

    <script>
    // ===================== CONSTANTS =====================
    const DAY_NAMES = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const DAY_NAMES_FULL = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
    const ORG_COLORS = ['#2196F3','#FF9800','#4CAF50','#9C27B0','#F44336','#00BCD4','#795548','#607D8B','#E91E63','#3F51B5',
                        '#8BC34A','#FF5722','#009688','#673AB7','#FFC107','#03A9F4','#CDDC39','#FF4081','#536DFE','#76FF03'];

    // ===================== SERVER SYNC =====================
    let _lastDataHash = '';

    function syncToServer(endpoint, data) {
        fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        }).catch(err => console.warn('Server sync failed:', err));
    }

    async function fetchFromServer(endpoint) {
        try {
            const resp = await fetch(endpoint);
            if (resp.ok) return await resp.json();
        } catch (err) {
            console.warn('Server fetch failed, using localStorage:', err);
        }
        return null;
    }

    function migrateData(data) {
        (data.organizations || []).forEach(o => {
            if (!o.minPerDay) o.minPerDay = 100;
            if (!o.scheduleType) o.scheduleType = 'daily';
            if (!o.scheduleDays) o.scheduleDays = [];
            if (o.weeklyTotal === undefined) o.weeklyTotal = 0;
            if (o.location === undefined) o.location = '';
            if (o.mediaOfficer === undefined) o.mediaOfficer = '';
        });
        (data.days || []).forEach(d => {
            if (d.location === undefined) d.location = '';
            if (d.mediaOfficer === undefined) d.mediaOfficer = '';
            if (d.locked === undefined) d.locked = false;
            (d.allocations || []).forEach(a => {
                if (a.mediaOfficer === undefined) a.mediaOfficer = '';
                if (a.location === undefined) a.location = '';
                if (a.contactPerson === undefined) a.contactPerson = '';
                if (a.contactNumber === undefined) a.contactNumber = '';
            });
        });
        return data;
    }

    async function initFromServer() {
        const serverSettings = await fetchFromServer('/api/settings');
        if (serverSettings) {
            settings = serverSettings;
            localStorage.setItem('ifthar_settings', JSON.stringify(settings));
        }
        const serverData = await fetchFromServer('/api/data');
        if (serverData && serverData.days) {
            migrateData(serverData);
            appData = serverData;
            localStorage.setItem('ifthar_app_data', JSON.stringify(appData));
            _lastDataHash = JSON.stringify(appData);
        }
    }

    // ===================== SETTINGS =====================
    function loadSettings() {
        try {
            const s = localStorage.getItem('ifthar_settings');
            if (s) return JSON.parse(s);
        } catch(e) {}
        return null;
    }
    function saveSettingsToStorage(s) {
        localStorage.setItem('ifthar_settings', JSON.stringify(s));
        syncToServer('/api/settings', s);
    }
    let settings = loadSettings();

    // ===================== SETUP =====================
    function showSetupIfNeeded() {
        if (!settings) document.getElementById('setupModal').classList.add('active');
    }

    function completeSetup() {
        const orgName = document.getElementById('setupOrgName').value.trim();
        const capacity = parseInt(document.getElementById('setupCapacity').value) || 0;
        const totalDays = parseInt(document.getElementById('setupTotalDays').value) || 30;
        const startDate = document.getElementById('setupStartDate').value;
        if (!orgName) return alert('Please enter your organization name.');
        if (capacity <= 0) return alert('Please enter a valid daily capacity.');
        if (!startDate) return alert('Please select a start date.');
        settings = { orgName, dailyCapacity: capacity, totalDays, startDate };
        saveSettingsToStorage(settings);
        appData = getDefaultData();
        saveData();
        document.getElementById('setupModal').classList.remove('active');
        applySettings();
        refresh();
    }

    // ===================== DATA MODEL =====================
    function getDefaultData() {
        const days = [];
        const totalDays = settings ? settings.totalDays : 30;
        const startDate = settings ? new Date(settings.startDate + 'T00:00:00') : new Date();
        for (let i = 0; i < totalDays; i++) {
            const d = new Date(startDate);
            d.setDate(d.getDate() + i);
            days.push({
                day: i + 1,
                date: d.toISOString().split('T')[0],
                allocations: [],
                status: 'pending',
                actualCooked: 0,
                actualDistributed: 0,
                notes: '',
                mediaLink: '',
                locked: false
            });
        }
        return { organizations: [], days, version: 2 };
    }

    function loadData() {
        try {
            const s = localStorage.getItem('ifthar_app_data');
            if (s) {
                const data = JSON.parse(s);
                if (data.days && data.days.length > 0) {
                    // Migrate orgs: ensure schedule fields exist
                    (data.organizations || []).forEach(o => {
                        if (!o.minPerDay) o.minPerDay = 100;
                        if (!o.scheduleType) o.scheduleType = 'daily';
                        if (!o.scheduleDays) o.scheduleDays = [];
                        if (o.location === undefined) o.location = '';
                        if (o.mediaOfficer === undefined) o.mediaOfficer = '';
                    });
                    // Migrate days: ensure fields exist
                    (data.days || []).forEach(d => {
                        if (d.location === undefined) d.location = '';
                        if (d.mediaOfficer === undefined) d.mediaOfficer = '';
                        if (d.locked === undefined) d.locked = false;
                        (d.allocations || []).forEach(a => {
                            if (a.contactPerson === undefined) a.contactPerson = '';
                            if (a.contactNumber === undefined) a.contactNumber = '';
                        });
                    });
                    return data;
                }
            }
        } catch(e) {}
        return getDefaultData();
    }

    function saveData() {
        localStorage.setItem('ifthar_app_data', JSON.stringify(appData));
        _lastDataHash = JSON.stringify(appData);
        syncToServer('/api/data', appData);
    }

    let appData = loadData();

    // ===================== UI SETTINGS =====================
    function applySettings() {
        if (!settings) return;
        const s = settings;
        document.title = `${s.orgName} - Ifthar Project Management`;
        document.getElementById('header-logo').textContent = s.orgName.charAt(0).toUpperCase();
        document.getElementById('header-title').textContent = `${s.orgName} Ifthar Management`;
        document.getElementById('header-subtitle').textContent = `Daily Capacity: ${s.dailyCapacity.toLocaleString()} Meals`;
        document.getElementById('capacity-chart-title').textContent = `Capacity Overview (${s.totalDays} Days)`;
        document.getElementById('daily-plan-title').textContent = `${s.totalDays}-Day Plan`;
        document.getElementById('daily-plan-desc').textContent = `Click any day to manage. Auto-Schedule distributes meals respecting each org's schedule rules and minimum per day.`;
        document.getElementById('report-title').textContent = `Summary Report - ${s.orgName} Ifthar Project`;
        document.getElementById('settingOrgName').value = s.orgName;
        document.getElementById('settingCapacity').value = s.dailyCapacity;
        document.getElementById('settingTotalDays').value = s.totalDays;
        document.getElementById('settingStartDate').value = s.startDate;
    }

    function saveSettings() {
        const orgName = document.getElementById('settingOrgName').value.trim();
        const capacity = parseInt(document.getElementById('settingCapacity').value) || 0;
        const totalDays = parseInt(document.getElementById('settingTotalDays').value) || 30;
        const startDate = document.getElementById('settingStartDate').value;
        if (!orgName) return alert('Please enter your organization name.');
        if (capacity <= 0) return alert('Please enter a valid daily capacity.');
        if (!startDate) return alert('Please select a start date.');
        const dateChanged = startDate !== settings.startDate;
        const totalChanged = totalDays !== settings.totalDays;
        settings = { orgName, dailyCapacity: capacity, totalDays, startDate };
        saveSettingsToStorage(settings);
        if (totalChanged) {
            if (confirm('Total days changed. Rebuild daily plan? (Organizations will be kept, allocations will be reset.)')) {
                const orgs = appData.organizations;
                appData = getDefaultData();
                appData.organizations = orgs;
                saveData();
            }
        } else if (dateChanged) {
            // Only update dates on existing days  keep all allocations intact
            const start = new Date(startDate + 'T00:00:00');
            appData.days.forEach(d => {
                const dt = new Date(start);
                dt.setDate(dt.getDate() + d.day - 1);
                d.date = dt.getFullYear() + '-' + String(dt.getMonth() + 1).padStart(2, '0') + '-' + String(dt.getDate()).padStart(2, '0');
            });
            saveData();
        }
        applySettings();
        refresh();
        alert('Settings saved!');
    }

    // ===================== BACKUPS =====================
    async function loadBackups() {
        const container = document.getElementById('backups-list');
        try {
            const res = await fetch('/api/backups');
            const backups = await res.json();
            if (backups.length === 0) {
                container.innerHTML = '<div style="color:var(--gray-500);text-align:center;padding:12px">No backups yet. Backups are created when you save data.</div>';
                return;
            }
            let html = '<div class="table-wrap"><table><thead><tr><th>Date & Time</th><th>Size</th><th></th></tr></thead><tbody>';
            backups.forEach(b => {
                const d = new Date(b.created);
                const dateStr = d.toLocaleDateString('en-GB', { day:'2-digit', month:'short', year:'numeric' }) + ' ' + d.toLocaleTimeString('en-GB', { hour:'2-digit', minute:'2-digit' });
                const sizeKB = (b.size / 1024).toFixed(1) + ' KB';
                html += `<tr>
                    <td>${dateStr}</td>
                    <td>${sizeKB}</td>
                    <td><button class="btn btn-sm btn-outline" onclick="restoreBackup('${b.filename}')">Restore</button></td>
                </tr>`;
            });
            html += '</tbody></table></div>';
            container.innerHTML = html;
        } catch (e) {
            container.innerHTML = '<div style="color:var(--gray-500);text-align:center;padding:12px">Could not load backups.</div>';
        }
    }

    async function restoreBackup(filename) {
        if (!confirm('Restore this backup? Current data will be replaced with the backup data.')) return;
        if (!confirm('Are you sure? This will overwrite all current settings and schedule data.')) return;
        try {
            const res = await fetch('/api/backups/restore/' + filename, { method: 'POST' });
            const result = await res.json();
            if (result.ok) {
                alert('Backup restored successfully! Page will reload.');
                location.reload();
            } else {
                alert('Restore failed: ' + (result.error || 'Unknown error'));
            }
        } catch (e) {
            alert('Restore failed: ' + e.message);
        }
    }

    // ===================== NAVIGATION =====================
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById('page-' + tab.dataset.page).classList.add('active');
            // Show/hide sticky compose bar
            const composeBar = document.getElementById('updCompose');
            if (composeBar) composeBar.style.display = tab.dataset.page === 'updates' ? '' : 'none';
            refresh();
        });
    });
    // Initially hide compose bar (only show on updates page)
    (function(){ var c = document.getElementById('updCompose'); if(c) c.style.display = 'none'; })();

    // ===================== TOGGLE WEEKLY DAYS =====================
    function toggleDayChecks() {
        const type = document.getElementById('orgScheduleType').value;
        document.getElementById('weeklyDaysGroup').style.display = type === 'weekly' ? '' : 'none';
        document.getElementById('weeklyTotalGroup').style.display = type === 'weekly-total' ? '' : 'none';
        // For auto and weekly-total, min meals/day is optional hint
    }

    function toggleEditScheduleType() {
        const type = document.getElementById('editOrgScheduleType').value;
        document.getElementById('editWeeklyGroup').style.display = type === 'weekly' ? '' : 'none';
        document.getElementById('editWeeklyTotalGroup').style.display = type === 'weekly-total' ? '' : 'none';
    }

    // ===================== ORGANIZATIONS =====================
    function addOrganization() {
        const name = document.getElementById('orgName').value.trim();
        const qty = parseInt(document.getElementById('orgQty').value) || 0;
        const minPerDay = parseInt(document.getElementById('orgMinPerDay').value) || 100;
        const scheduleType = document.getElementById('orgScheduleType').value;
        const contact = document.getElementById('orgContact').value.trim();
        const phone = document.getElementById('orgPhone').value.trim();
        const notes = document.getElementById('orgNotes').value.trim();

        let scheduleDays = [];
        let weeklyTotal = 0;
        if (scheduleType === 'weekly') {
            document.querySelectorAll('#orgWeeklyDays input:checked').forEach(cb => {
                scheduleDays.push(parseInt(cb.value));
            });
            if (scheduleDays.length === 0) return alert('Please select at least one day of the week.');
        }
        if (scheduleType === 'weekly-total') {
            weeklyTotal = parseInt(document.getElementById('orgWeeklyTotal').value) || 0;
            if (weeklyTotal <= 0) return alert('Please enter a valid weekly meal total.');
        }

        if (!name) return alert('Please enter organization name');
        if (qty <= 0) return alert('Please enter a valid meal quantity');
        if (minPerDay < 1) return alert('Min meals per day must be at least 1');

        appData.organizations.push({
            id: Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
            name, qty, minPerDay, scheduleType, scheduleDays, weeklyTotal,
            contact, phone, notes,
            dateAdded: new Date().toISOString().split('T')[0]
        });

        // Reset form
        document.getElementById('orgName').value = '';
        document.getElementById('orgQty').value = '';
        document.getElementById('orgMinPerDay').value = '100';
        document.getElementById('orgScheduleType').value = 'daily';
        document.getElementById('orgContact').value = '';
        document.getElementById('orgPhone').value = '';
        document.getElementById('orgNotes').value = '';
        document.getElementById('orgWeeklyTotal').value = '';
        document.querySelectorAll('#orgWeeklyDays input').forEach(cb => cb.checked = false);
        toggleDayChecks();

        saveData();
        refresh();
    }

    function deleteOrganization(id) {
        if (!confirm('Delete this organization and its allocations?')) return;
        appData.organizations = appData.organizations.filter(o => o.id !== id);
        // Remove from completed days too
        appData.days.forEach(day => { day.allocations = day.allocations.filter(a => a.orgId !== id); });
        saveData();
        refresh();
    }

    function openEditOrgModal(id) {
        const org = appData.organizations.find(o => o.id === id);
        if (!org) return;
        const idx = appData.organizations.indexOf(org);

        let daysChecks = DAY_NAMES.map((name, i) =>
            `<label class="day-check"><input type="checkbox" class="edit-day-cb" value="${i}" ${(org.scheduleDays || []).includes(i) ? 'checked' : ''}> ${name}</label>`
        ).join('');

        document.getElementById('edit-org-body').innerHTML = `
            <div class="form-group" style="margin-bottom:12px">
                <label>Organization Name</label>
                <input type="text" id="editOrgName" value="${esc(org.name)}">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Total Meals</label>
                    <input type="number" id="editOrgQty" value="${org.qty}" min="1">
                </div>
                <div class="form-group">
                    <label>Min Meals / Day</label>
                    <input type="number" id="editOrgMinPerDay" value="${org.minPerDay || 100}" min="1">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Schedule Type</label>
                    <select id="editOrgScheduleType" onchange="toggleEditScheduleType()">
                        <option value="daily" ${org.scheduleType === 'daily' ? 'selected' : ''}>Every Day</option>
                        <option value="alternate" ${org.scheduleType === 'alternate' ? 'selected' : ''}>Every Other Day</option>
                        <option value="weekly" ${org.scheduleType === 'weekly' ? 'selected' : ''}>Specific Day(s)</option>
                        <option value="weekly-total" ${org.scheduleType === 'weekly-total' ? 'selected' : ''}>Weekly Total (system splits)</option>
                        <option value="auto" ${org.scheduleType === 'auto' ? 'selected' : ''}>Auto (system decides)</option>
                    </select>
                </div>
                <div class="form-group" id="editWeeklyGroup" style="display:${org.scheduleType === 'weekly' ? '' : 'none'}">
                    <label>Days</label>
                    <div class="day-checks">${daysChecks}</div>
                </div>
                <div class="form-group" id="editWeeklyTotalGroup" style="display:${org.scheduleType === 'weekly-total' ? '' : 'none'}">
                    <label>Meals Per Week</label>
                    <input type="number" id="editOrgWeeklyTotal" value="${org.weeklyTotal || ''}" min="1" placeholder="e.g. 500">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Contact</label><input type="text" id="editOrgContact" value="${esc(org.contact || '')}"></div>
                <div class="form-group"><label>Phone</label><input type="text" id="editOrgPhone" value="${esc(org.phone || '')}"></div>
            </div>
            <div class="form-group" style="margin-bottom:16px"><label>Notes</label><input type="text" id="editOrgNotes" value="${esc(org.notes || '')}"></div>
            <div style="display:flex;gap:10px;justify-content:flex-end">
                <button class="btn btn-outline" onclick="closeEditOrgModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveEditOrg('${org.id}')">Save Changes</button>
            </div>`;

        document.getElementById('editOrgModal').classList.add('active');
    }

    function closeEditOrgModal() { document.getElementById('editOrgModal').classList.remove('active'); }

    function saveEditOrg(id) {
        const org = appData.organizations.find(o => o.id === id);
        if (!org) return;

        org.name = document.getElementById('editOrgName').value.trim();
        org.qty = parseInt(document.getElementById('editOrgQty').value) || org.qty;
        org.minPerDay = parseInt(document.getElementById('editOrgMinPerDay').value) || 100;
        org.scheduleType = document.getElementById('editOrgScheduleType').value;
        org.contact = document.getElementById('editOrgContact').value.trim();
        org.phone = document.getElementById('editOrgPhone').value.trim();
        org.notes = document.getElementById('editOrgNotes').value.trim();

        org.scheduleDays = [];
        org.weeklyTotal = 0;
        if (org.scheduleType === 'weekly') {
            document.querySelectorAll('.edit-day-cb:checked').forEach(cb => {
                org.scheduleDays.push(parseInt(cb.value));
            });
            if (org.scheduleDays.length === 0) return alert('Select at least one day.');
        }
        if (org.scheduleType === 'weekly-total') {
            org.weeklyTotal = parseInt(document.getElementById('editOrgWeeklyTotal').value) || 0;
            if (org.weeklyTotal <= 0) return alert('Please enter a valid weekly meal total.');
        }

        // Update name in completed day allocations
        appData.days.forEach(day => {
            if (day.status === 'cooking' || day.status === 'cooked' || day.status === 'distributed' || day.status === 'reported') {
                day.allocations.forEach(a => { if (a.orgId === id) a.orgName = org.name; });
            }
        });

        saveData();
        closeEditOrgModal();
        refresh();
    }

    function viewOrgSchedule(id) {
        const org = appData.organizations.find(o => o.id === id);
        if (!org || !settings) return;

        const idx = appData.organizations.indexOf(org);
        const color = ORG_COLORS[idx % ORG_COLORS.length];

        // Collect all days where this org has allocations
        let totalAllocated = 0;
        let daysWithAlloc = 0;
        let tableRows = '';

        appData.days.forEach(day => {
            const alloc = day.allocations.find(a => a.orgId === id);
            const qty = alloc ? alloc.qty : 0;
            if (qty > 0) {
                daysWithAlloc++;
                totalAllocated += qty;
            }
            const dayDate = new Date(day.date + 'T00:00:00');
            const dayName = DAY_NAMES_FULL[dayDate.getDay()];
            const sStatus = day.status === 'pending' ? 'scheduled' : day.status;
            const sNames = { scheduled:'Scheduled', cooking:'Cooking', cooked:'Cooked', distributed:'Distributed', reported:'Reported' };
            const statusBadge = `<span class="badge badge-${sStatus}">${sNames[sStatus] || sStatus}</span>`;
            const staff = alloc && alloc.mediaOfficer ? esc(alloc.mediaOfficer) : '-';
            const location = alloc && alloc.location ? esc(alloc.location) : '-';

            tableRows += `<tr style="${qty > 0 ? '' : 'opacity:0.4'}">
                <td><strong>Day ${day.day}</strong></td>
                <td>${formatDate(day.date)}<br><span style="font-size:0.7rem;color:var(--gray-400)">${dayName}</span></td>
                <td style="font-weight:${qty > 0 ? '700' : '400'};color:${qty > 0 ? 'var(--primary)' : 'var(--gray-300)'}">${qty > 0 ? qty.toLocaleString() : '-'}</td>
                <td>${staff}</td>
                <td>${location}</td>
                <td>${statusBadge}</td>
            </tr>`;
        });

        const remaining = org.qty - totalAllocated;

        const html = `
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px">
                <span style="display:inline-block;width:18px;height:18px;border-radius:4px;background:${color}"></span>
                <div>
                    <div style="font-weight:700;font-size:1rem">${esc(org.name)}</div>
                    <div style="font-size:0.78rem;color:var(--gray-500)">${esc(getScheduleLabel(org))} | Min ${(org.minPerDay || 100).toLocaleString()}/day</div>
                </div>
            </div>
            <div class="stats-grid" style="margin-bottom:14px">
                <div class="stat-card"><div class="stat-label">Total Meals</div><div class="stat-value">${org.qty.toLocaleString()}</div></div>
                <div class="stat-card accent"><div class="stat-label">Allocated</div><div class="stat-value">${totalAllocated.toLocaleString()}</div></div>
                <div class="stat-card ${remaining > 0 ? 'warning' : 'success'}"><div class="stat-label">${remaining > 0 ? 'Remaining' : 'Fully Used'}</div><div class="stat-value">${Math.abs(remaining).toLocaleString()}</div></div>
                <div class="stat-card info"><div class="stat-label">Days Active</div><div class="stat-value">${daysWithAlloc} / ${settings.totalDays}</div></div>
            </div>
            <div style="display:flex;gap:8px;margin-bottom:12px;justify-content:flex-end">
                <button class="btn btn-sm btn-accent" onclick="printOrgSchedule('${id}')">Print Schedule</button>
            </div>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Day</th><th>Date</th><th>Meals</th><th>Staff</th><th>Location</th><th>Status</th></tr></thead>
                    <tbody>${tableRows}</tbody>
                </table>
            </div>`;

        document.getElementById('modal-day-title').textContent = org.name + '  Full Schedule';
        document.getElementById('modal-day-body').innerHTML = html;
        document.getElementById('dayModal').classList.add('active');
    }

    function printOrgSchedule(id) {
        const org = appData.organizations.find(o => o.id === id);
        if (!org) return;
        const modal = document.getElementById('dayModal');
        modal.classList.add('print-org-schedule');
        document.title = org.name + ' - Schedule';
        doPrint(function() {
            modal.classList.remove('print-org-schedule');
            document.title = 'Ifthar Project Management';
        });
    }

    function getScheduleLabel(org) {
        if (org.scheduleType === 'daily') return 'Every Day';
        if (org.scheduleType === 'alternate') return 'Every Other Day';
        if (org.scheduleType === 'weekly') {
            const days = (org.scheduleDays || []).map(d => DAY_NAMES[d]).join(', ');
            return days || 'Weekly';
        }
        if (org.scheduleType === 'weekly-total') return (org.weeklyTotal || 0).toLocaleString() + '/week';
        if (org.scheduleType === 'auto') return 'Auto';
        return 'Every Day';
    }

    function renderOrganizations() {
        const tbody = document.querySelector('#org-table tbody');
        const empty = document.getElementById('org-empty');

        if (appData.organizations.length === 0) {
            tbody.innerHTML = '';
            empty.style.display = '';
            document.getElementById('org-count').textContent = '';
            return;
        }

        empty.style.display = 'none';
        document.getElementById('org-count').textContent = `${appData.organizations.length} organization(s)`;

        tbody.innerHTML = appData.organizations.map((org, idx) => {
            const color = ORG_COLORS[idx % ORG_COLORS.length];
            const allocated = getAllocatedForOrg(org.id);
            return `<tr>
                <td><span style="display:inline-block;width:14px;height:14px;border-radius:3px;background:${color}"></span></td>
                <td><strong>${esc(org.name)}</strong>${org.notes ? '<br><span style="font-size:0.72rem;color:var(--gray-500)">' + esc(org.notes) + '</span>' : ''}</td>
                <td>${org.qty.toLocaleString()} <span style="font-size:0.72rem;color:var(--gray-500)">(${allocated.toLocaleString()} alloc)</span></td>
                <td><span class="badge badge-${org.scheduleType}">${esc(getScheduleLabel(org))}</span></td>
                <td>${(org.minPerDay || 100).toLocaleString()}</td>
                <td>${esc(org.contact || '-')}</td>
                <td>${esc(org.phone || '-')}</td>
                <td style="white-space:nowrap">
                    <button class="btn btn-sm btn-accent" onclick="viewOrgSchedule('${org.id}')">Schedule</button>
                    <button class="btn btn-sm btn-outline" onclick="openEditOrgModal('${org.id}')">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteOrganization('${org.id}')">Delete</button>
                </td>
            </tr>`;
        }).join('');
    }

    function getAllocatedForOrg(orgId) {
        let total = 0;
        appData.days.forEach(day => { day.allocations.forEach(a => { if (a.orgId === orgId) total += a.qty; }); });
        return total;
    }

    // ===================== SMART AUTO-SCHEDULER =====================
    // Core scheduler: reschedules UNLOCKED pending days only.
    // Locked days: completed (cooked/distributed) OR manually edited.
    // Each org gets EXACTLY their fixed daily minimum on scheduled days.
    // Daily total = sum of minimums (varies day to day, never exceeds capacity).
    function isDayLocked(day) {
        if (day.status === 'cooking' || day.status === 'cooked' || day.status === 'distributed' || day.status === 'reported' || day.locked) return true;
        // Lock today, tomorrow, and past days
        const now = new Date();
        const todayStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
        const tmrw = new Date(now);
        tmrw.setDate(tmrw.getDate() + 1);
        const tmrwStr = tmrw.getFullYear() + '-' + String(tmrw.getMonth() + 1).padStart(2, '0') + '-' + String(tmrw.getDate()).padStart(2, '0');
        return day.date <= tmrwStr;
    }

    // Round to nearest nice number (nearest 10 for small, 50 for large)
    function roundNice(n) {
        if (n <= 0) return 0;
        if (n < 50) return Math.round(n / 5) * 5 || 5;
        if (n < 200) return Math.round(n / 10) * 10 || 10;
        return Math.round(n / 50) * 50 || 50;
    }

    function runScheduler() {
        if (!settings || appData.organizations.length === 0) return;

        const cap = settings.dailyCapacity;
        const totalDays = appData.days.length;

        // Build pool with remaining qty tracker
        const pool = appData.organizations.map((o, idx) => ({
            id: o.id,
            name: o.name,
            remaining: o.qty,
            minPerDay: o.minPerDay || 100,
            scheduleType: o.scheduleType || 'daily',
            scheduleDays: o.scheduleDays || [],
            weeklyTotal: o.weeklyTotal || 0,
            altGroup: idx % 2
        }));

        // First pass: subtract already-used qty from locked days
        for (const day of appData.days) {
            if (isDayLocked(day)) {
                for (const alloc of day.allocations) {
                    const org = pool.find(o => o.id === alloc.orgId);
                    if (org) org.remaining -= alloc.qty;
                }
            }
        }

        // Pre-calculate weekly-total splits per week
        // Group days by week number
        const weekMap = {}; // weekKey -> [dayIndex, ...]
        appData.days.forEach((day, di) => {
            const d = new Date(day.date + 'T00:00:00');
            // Week number: days since start / 7
            const weekNum = Math.floor(di / 7);
            if (!weekMap[weekNum]) weekMap[weekNum] = [];
            weekMap[weekNum].push(di);
        });

        // For weekly-total orgs, pre-compute how much each day gets
        const weeklyDailyAmounts = {}; // orgId -> { dayIndex: amount }
        pool.filter(o => o.scheduleType === 'weekly-total' && o.weeklyTotal > 0).forEach(org => {
            weeklyDailyAmounts[org.id] = {};
            let totalAssigned = 0;
            const minDay = org.minPerDay || 100;

            for (const weekNum of Object.keys(weekMap).sort((a, b) => a - b)) {
                const dayIndices = weekMap[weekNum];
                const unlocked = dayIndices.filter(di => !isDayLocked(appData.days[di]));
                if (unlocked.length === 0) continue;

                // How much to give this week (capped by remaining)
                let weekBudget = Math.min(org.weeklyTotal, org.remaining - totalAssigned);
                if (weekBudget <= 0) break;

                // How many days can we fill respecting minPerDay?
                // e.g. 500/week with min 250 = 2 days, not 7
                let numDays = Math.min(unlocked.length, Math.floor(weekBudget / minDay));
                if (numDays < 1) numDays = 1; // at least 1 day even if below min

                // Pick random days from this week
                const shuffled = [...unlocked];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                const selectedDays = shuffled.slice(0, numDays);

                // Split budget into rounded amounts across selected days
                const amounts = [];
                let left = weekBudget;
                for (let i = 0; i < numDays; i++) {
                    if (i === numDays - 1) {
                        // Last day gets the remainder
                        amounts.push(roundNice(left));
                    } else {
                        // Random portion but at least minPerDay
                        const evenShare = left / (numDays - i);
                        const lo = Math.max(minDay, evenShare * 0.7);
                        const hi = Math.max(minDay, evenShare * 1.3);
                        const raw = lo + Math.random() * (hi - lo);
                        const rounded = roundNice(raw);
                        const give = Math.min(rounded, left - minDay * (numDays - i - 1)); // leave enough for rest
                        amounts.push(Math.max(give, minDay));
                        left -= amounts[amounts.length - 1];
                    }
                }

                selectedDays.forEach((di, i) => {
                    weeklyDailyAmounts[org.id][di] = amounts[i] || 0;
                    totalAssigned += amounts[i] || 0;
                });
            }
        });

        // Second pass: schedule all unlocked pending days
        // Phase 1: fixed-schedule orgs (daily, alternate, weekly, weekly-total)
        for (let di = 0; di < totalDays; di++) {
            const day = appData.days[di];
            if (isDayLocked(day)) continue;

            const dayDate = new Date(day.date + 'T00:00:00');
            const dow = dayDate.getDay();
            let dayTotal = 0;
            const dayAllocs = [];

            // Fixed-schedule orgs
            const fixedOrgs = pool.filter(org => {
                if (org.remaining <= 0) return false;
                if (org.scheduleType === 'auto') return false; // handled in phase 2
                switch (org.scheduleType) {
                    case 'daily': return true;
                    case 'alternate': return (di % 2) === org.altGroup;
                    case 'weekly': return org.scheduleDays.includes(dow);
                    case 'weekly-total': return (weeklyDailyAmounts[org.id] && weeklyDailyAmounts[org.id][di] > 0);
                    default: return true;
                }
            });

            for (const org of fixedOrgs) {
                let give;
                if (org.scheduleType === 'weekly-total') {
                    give = weeklyDailyAmounts[org.id][di] || 0;
                    give = Math.min(give, org.remaining);
                } else if (org.remaining > 0 && org.remaining < org.minPerDay) {
                    give = org.remaining;
                } else {
                    give = org.minPerDay;
                }
                if (give <= 0) continue;
                if (dayTotal + give > cap) continue;
                dayAllocs.push({ orgId: org.id, orgName: org.name, qty: give, mediaOfficer: '', location: '', contactPerson: '', contactNumber: '' });
                org.remaining -= give;
                dayTotal += give;
            }

            day.allocations = dayAllocs;
            day._dayTotal = dayTotal; // temp for phase 2
        }

        // Phase 2: Auto orgs  fill gaps where capacity isn't met
        const autoOrgs = pool.filter(o => o.scheduleType === 'auto' && o.remaining > 0);
        if (autoOrgs.length > 0) {
            // Sort days by most empty first (most gap to fill)
            const unlockedDays = [];
            for (let di = 0; di < totalDays; di++) {
                const day = appData.days[di];
                if (isDayLocked(day)) continue;
                const gap = cap - (day._dayTotal || 0);
                if (gap > 0) unlockedDays.push({ di, gap });
            }
            unlockedDays.sort((a, b) => b.gap - a.gap);

            for (const org of autoOrgs) {
                for (const entry of unlockedDays) {
                    if (org.remaining <= 0) break;
                    const day = appData.days[entry.di];
                    const currentTotal = day.allocations.reduce((s, a) => s + a.qty, 0);
                    const gap = cap - currentTotal;
                    if (gap <= 0) continue;

                    const give = Math.min(roundNice(Math.min(org.minPerDay, gap)), org.remaining, gap);
                    if (give <= 0) continue;

                    day.allocations.push({ orgId: org.id, orgName: org.name, qty: give, mediaOfficer: '', location: '', contactPerson: '', contactNumber: '' });
                    org.remaining -= give;
                    entry.gap -= give;
                }
            }
        }

        // Clean temp
        appData.days.forEach(d => delete d._dayTotal);

        saveData();
    }

    // Button handler: runs scheduler with confirmation + marks today as completed
    function autoSchedule() {
        if (!settings) return;
        if (appData.organizations.length === 0) return alert('Add organizations first.');

        const now = new Date();
        const todayStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');

        const protectedDays = appData.days.filter(d => isDayLocked(d));
        const futureDays = appData.days.filter(d => !isDayLocked(d));

        const manualDays = appData.days.filter(d => !isDayLocked(d) && d.locked && d.allocations.length > 0);
        let confirmMsg = `This will reschedule ${futureDays.length - manualDays.length} future day(s).`;
        if (protectedDays.length > 0) {
            confirmMsg += `\n\n${protectedDays.length} day(s) (today, tomorrow, past & completed) will NOT be changed.`;
        }
        if (manualDays.length > 0) {
            confirmMsg += `\n${manualDays.length} manually edited day(s) will be kept.`;
        }
        if (!confirm(confirmMsg + '\n\nContinue?')) return;

        // Only clear locks on future pending days that have NO manual allocations
        // Days that user manually edited (locked + has allocations) are kept
        const tmrw = new Date(now);
        tmrw.setDate(tmrw.getDate() + 1);
        const tmrwStr = tmrw.getFullYear() + '-' + String(tmrw.getMonth() + 1).padStart(2, '0') + '-' + String(tmrw.getDate()).padStart(2, '0');
        appData.days.forEach(d => {
            // Never touch today, tomorrow, past, or completed days
            if (d.date <= tmrwStr) return;
            if (d.status === 'cooking' || d.status === 'cooked' || d.status === 'distributed' || d.status === 'reported') return;
            // If day was manually edited (locked + has allocations), keep it
            if (d.locked && d.allocations.length > 0) return;
            d.locked = false;
        });

        runScheduler();
        refresh();

        // Summary
        const totalAllocated = appData.days.reduce((s, d) => s + d.allocations.reduce((ss, a) => ss + a.qty, 0), 0);
        const totalReceived = appData.organizations.reduce((s, o) => s + o.qty, 0);

        let msg = `Schedule complete!\n`;
        msg += `\n${protectedDays.length} day(s) kept as-is (today/past/completed)`;
        msg += `\n${futureDays.length} future day(s) scheduled`;
        msg += `\nTotal allocated: ${totalAllocated.toLocaleString()} / ${totalReceived.toLocaleString()} meals`;
        alert(msg);
    }

    // clearAllocations removed - data protection

    // ===================== DAYS GRID =====================
    function renderDaysGrid() {
        if (!settings) return;
        const grid = document.getElementById('days-grid');
        const today = new Date().toISOString().split('T')[0];
        const cap = settings.dailyCapacity;

        grid.innerHTML = appData.days.map(day => {
            const total = day.allocations.reduce((s, a) => s + a.qty, 0);
            const pct = cap > 0 ? Math.round((total / cap) * 100) : 0;
            const isToday = day.date === today;
            const barColor = pct >= 100 ? 'green' : pct >= 50 ? 'yellow' : 'red';
            const orgNames = day.allocations.map(a => a.orgName).join(', ');
            const dayDate = new Date(day.date + 'T00:00:00');
            const dayName = DAY_NAMES[dayDate.getDay()];

            const isLocked = day.locked || day.status === 'cooked' || day.status === 'distributed' || day.status === 'cooking' || day.status === 'reported';
            const displayStatus = day.status === 'pending' ? 'scheduled' : day.status;
            const statusNames = { scheduled:'Scheduled', cooking:'Cooking', cooked:'Cooked', distributed:'Distributed', reported:'Reported', pending:'Scheduled' };
            return `<div class="day-card status-${displayStatus} ${isToday ? 'today' : ''}" onclick="openDayModal(${day.day})">
                <div class="day-num">Day ${day.day} <span style="font-weight:400;font-size:0.8rem;color:var(--gray-500)">${dayName}</span>${isLocked ? ' <span title="Locked - won\'t change on reschedule" style="font-size:0.7rem">&#128274;</span>' : ''}</div>
                <div class="day-date">${formatDate(day.date)}${isToday ? ' (Today)' : ''}</div>
                <div class="day-meals">${total.toLocaleString()} / ${cap.toLocaleString()}</div>
                <div class="progress-bar"><div class="progress-fill ${barColor}" style="width:${Math.min(pct,100)}%"></div></div>
                <div class="day-orgs">${day.allocations.map(a => {
                    let t = a.orgName;
                    if (a.mediaOfficer) t += ' - ' + a.mediaOfficer;
                    if (a.location) t += ' (' + a.location + ')';
                    if (a.contactPerson) t += ' [' + a.contactPerson + (a.contactNumber ? ': ' + a.contactNumber : '') + ']';
                    return t;
                }).join(', ') || 'No allocations'}</div>
                <div class="day-status"><span class="badge badge-${displayStatus}">${statusNames[displayStatus] || displayStatus}</span>${day.mediaLink ? ' <a href="' + esc(day.mediaLink) + '" target="_blank" onclick="event.stopPropagation()" style="font-size:0.7rem;color:var(--info)">Media</a>' : ''}</div>
            </div>`;
        }).join('');
    }

    // ===================== DAY MODAL =====================
    function openDayModal(dayNum) {
        if (!settings) return;
        const day = appData.days[dayNum - 1];
        if (!day) return;
        const cap = settings.dailyCapacity;
        const dayDate = new Date(day.date + 'T00:00:00');

        document.getElementById('modal-day-title').textContent = `Day ${dayNum} - ${DAY_NAMES_FULL[dayDate.getDay()]}, ${formatDate(day.date)}`;

        const total = day.allocations.reduce((s, a) => s + a.qty, 0);
        const remaining = cap - total;

        let html = `<div style="margin-bottom:14px">
            <div style="display:flex;justify-content:space-between;font-size:0.85rem;margin-bottom:4px">
                <span>Allocated: <strong>${total.toLocaleString()}</strong> / ${cap.toLocaleString()}</span>
                <span>Remaining: <strong style="color:${remaining > 0 ? 'var(--danger)' : 'var(--success)'}">${remaining.toLocaleString()}</strong></span>
            </div>
            <div class="progress-bar" style="height:12px">
                <div class="progress-fill ${total >= cap ? 'green' : total >= cap/2 ? 'yellow' : 'red'}" style="width:${cap > 0 ? Math.min(Math.round(total/cap*100),100) : 0}%"></div>
            </div>
        </div>`;

        if (day.allocations.length > 0) {
            html += `<div style="margin-bottom:14px"><strong style="font-size:0.85rem">Allocations & Daily Assignment:</strong>
            <div style="overflow-x:auto"><table style="margin-top:6px"><thead><tr><th>Organization</th><th>Meals</th><th>Media Officer</th><th>Location</th><th>Contact Person</th><th>Contact No.</th><th></th></tr></thead><tbody>`;
            day.allocations.forEach((a, ai) => {
                html += `<tr>
                    <td><strong>${esc(a.orgName)}</strong></td>
                    <td>${a.qty.toLocaleString()}</td>
                    <td><input type="text" class="alloc-media" data-idx="${ai}" value="${esc(a.mediaOfficer || '')}" placeholder="Staff name" style="padding:4px 8px;border:1.5px solid var(--gray-200);border-radius:4px;font-size:0.82rem;width:120px"></td>
                    <td><input type="text" class="alloc-location" data-idx="${ai}" value="${esc(a.location || '')}" placeholder="Distribution point" style="padding:4px 8px;border:1.5px solid var(--gray-200);border-radius:4px;font-size:0.82rem;width:140px"></td>
                    <td><input type="text" class="alloc-contact" data-idx="${ai}" value="${esc(a.contactPerson || '')}" placeholder="Contact name" style="padding:4px 8px;border:1.5px solid var(--gray-200);border-radius:4px;font-size:0.82rem;width:120px"></td>
                    <td><input type="text" class="alloc-phone" data-idx="${ai}" value="${esc(a.contactNumber || '')}" placeholder="Phone" style="padding:4px 8px;border:1.5px solid var(--gray-200);border-radius:4px;font-size:0.82rem;width:110px"></td>
                    <td><button class="btn btn-sm btn-danger" onclick="removeDayAlloc(${dayNum},'${a.orgId}')">Remove</button></td>
                </tr>`;
            });
            html += `</tbody></table></div>`;
        }

        const unallocatedOrgs = appData.organizations.filter(o => !day.allocations.find(a => a.orgId === o.id));
        if (unallocatedOrgs.length > 0 && remaining > 0) {
            html += `<div style="margin-bottom:14px;padding:12px;background:var(--gray-50);border-radius:8px">
                <strong style="font-size:0.85rem">Add Allocation:</strong>
                <div class="form-row" style="margin-top:8px">
                    <div class="form-group"><label>Organization</label>
                        <select id="modal-alloc-org">${unallocatedOrgs.map(o => `<option value="${o.id}">${esc(o.name)}</option>`).join('')}</select>
                    </div>
                    <div class="form-group"><label>Meals (max ${remaining.toLocaleString()})</label>
                        <input type="number" id="modal-alloc-qty" max="${remaining}" min="1" value="${Math.min(remaining, unallocatedOrgs[0]?.minPerDay || 100)}">
                    </div>
                    <div class="form-group" style="display:flex;align-items:flex-end">
                        <button class="btn btn-primary btn-sm" onclick="addDayAlloc(${dayNum})">Add</button>
                    </div>
                </div>
            </div>`;
        }

        const statuses = ['scheduled','cooking','cooked','distributed','reported'];
        const statusLabels = { scheduled:'Scheduled', cooking:'Cooking', cooked:'Cooked', distributed:'Distributed', reported:'Reported' };
        const curStatus = (day.status === 'pending' ? 'scheduled' : day.status);
        html += `<div style="padding:12px;background:var(--gray-50);border-radius:8px">
            <strong style="font-size:0.85rem">Status:</strong>
            <div class="status-pills">
                ${statuses.map(s => `<button class="status-pill ${curStatus === s ? 'active-' + s : ''}" onclick="quickSetStatus(${dayNum},'${s}')">${statusLabels[s]}</button>`).join('')}
            </div>
            <div class="form-row" style="margin-top:12px">
                <div class="form-group"><label>Actual Cooked</label>
                    <input type="number" id="modal-cooked" value="${day.actualCooked}" min="0">
                </div>
                <div class="form-group"><label>Actual Distributed</label>
                    <input type="number" id="modal-distributed" value="${day.actualDistributed}" min="0">
                </div>
            </div>
            <div class="form-group" style="margin-top:8px"><label>Notes</label>
                <textarea id="modal-notes" rows="2" placeholder="Notes...">${esc(day.notes)}</textarea>
            </div>
            <div class="form-group" style="margin-top:8px"><label>Media Link</label>
                <div style="display:flex;gap:6px">
                    <input type="url" id="modal-medialink" value="${esc(day.mediaLink || '')}" placeholder="Google Drive, YouTube link..." style="flex:1">
                    ${day.mediaLink ? `<a href="${esc(day.mediaLink)}" target="_blank" class="btn btn-sm btn-outline">Open</a>` : ''}
                </div>
            </div>
            <div style="margin-top:10px">
                <button class="btn btn-success btn-sm" onclick="saveDayDetails(${dayNum})">Save Changes</button>
            </div>
        </div>`;

        document.getElementById('modal-day-body').innerHTML = html;
        document.getElementById('dayModal').classList.add('active');
    }

    function closeModal() { document.getElementById('dayModal').classList.remove('active'); }

    // Save current input values from modal before re-rendering
    function saveAllocInputs(dayNum) {
        const day = appData.days[dayNum - 1];
        if (!day) return;
        document.querySelectorAll('.alloc-media').forEach(el => {
            const idx = parseInt(el.dataset.idx);
            if (day.allocations[idx]) day.allocations[idx].mediaOfficer = el.value.trim();
        });
        document.querySelectorAll('.alloc-location').forEach(el => {
            const idx = parseInt(el.dataset.idx);
            if (day.allocations[idx]) day.allocations[idx].location = el.value.trim();
        });
        document.querySelectorAll('.alloc-contact').forEach(el => {
            const idx = parseInt(el.dataset.idx);
            if (day.allocations[idx]) day.allocations[idx].contactPerson = el.value.trim();
        });
        document.querySelectorAll('.alloc-phone').forEach(el => {
            const idx = parseInt(el.dataset.idx);
            if (day.allocations[idx]) day.allocations[idx].contactNumber = el.value.trim();
        });
    }

    function addDayAlloc(dayNum) {
        if (!settings) return;
        const day = appData.days[dayNum - 1];
        saveAllocInputs(dayNum);  // Preserve existing input values
        const orgId = document.getElementById('modal-alloc-org').value;
        const qty = parseInt(document.getElementById('modal-alloc-qty').value) || 0;
        const org = appData.organizations.find(o => o.id === orgId);
        if (!org || qty <= 0) return alert('Invalid allocation');
        const total = day.allocations.reduce((s, a) => s + a.qty, 0);
        if (total + qty > settings.dailyCapacity) return alert(`Exceeds daily capacity. Max: ${settings.dailyCapacity - total}`);
        day.allocations.push({ orgId: org.id, orgName: org.name, qty, mediaOfficer: '', location: '', contactPerson: '', contactNumber: '' });
        day.locked = true;
        saveData(); runScheduler(); openDayModal(dayNum); renderDaysGrid();
    }

    function removeDayAlloc(dayNum, orgId) {
        const day = appData.days[dayNum - 1];
        saveAllocInputs(dayNum);  // Preserve existing input values
        day.allocations = day.allocations.filter(a => a.orgId !== orgId);
        day.locked = true;
        saveData(); runScheduler(); openDayModal(dayNum); renderDaysGrid();
    }

    function quickSetStatus(dayNum, status) {
        const day = appData.days[dayNum - 1];
        if (!day) return;
        // Save any input values first
        saveAllocInputs(dayNum);
        const cookedEl = document.getElementById('modal-cooked');
        const distEl = document.getElementById('modal-distributed');
        const notesEl = document.getElementById('modal-notes');
        const mediaEl = document.getElementById('modal-medialink');
        if (cookedEl) day.actualCooked = parseInt(cookedEl.value) || 0;
        if (distEl) day.actualDistributed = parseInt(distEl.value) || 0;
        if (notesEl) day.notes = notesEl.value.trim();
        if (mediaEl) day.mediaLink = mediaEl.value.trim();
        day.status = status;
        day.locked = true;
        saveData();
        openDayModal(dayNum);
        renderDaysGrid();
    }

    function saveDayDetails(dayNum) {
        const day = appData.days[dayNum - 1];
        // Save per-allocation media officer and location
        document.querySelectorAll('.alloc-media').forEach(el => {
            const idx = parseInt(el.dataset.idx);
            if (day.allocations[idx]) day.allocations[idx].mediaOfficer = el.value.trim();
        });
        document.querySelectorAll('.alloc-location').forEach(el => {
            const idx = parseInt(el.dataset.idx);
            if (day.allocations[idx]) day.allocations[idx].location = el.value.trim();
        });
        document.querySelectorAll('.alloc-contact').forEach(el => {
            const idx = parseInt(el.dataset.idx);
            if (day.allocations[idx]) day.allocations[idx].contactPerson = el.value.trim();
        });
        document.querySelectorAll('.alloc-phone').forEach(el => {
            const idx = parseInt(el.dataset.idx);
            if (day.allocations[idx]) day.allocations[idx].contactNumber = el.value.trim();
        });
        day.actualCooked = parseInt(document.getElementById('modal-cooked').value) || 0;
        day.actualDistributed = parseInt(document.getElementById('modal-distributed').value) || 0;
        day.notes = document.getElementById('modal-notes').value.trim();
        day.mediaLink = (document.getElementById('modal-medialink').value || '').trim();
        day.locked = true;
        saveData();
        runScheduler();
        refresh(); closeModal();
    }

    // ===================== PRINTABLE DAILY SCHEDULE =====================
    function renderSchedule() {
        if (!settings) return;
        const cap = settings.dailyCapacity;
        let html = '';

        appData.days.forEach((day, di) => {
            const dayDate = new Date(day.date + 'T00:00:00');
            const dayName = DAY_NAMES_FULL[dayDate.getDay()];
            const total = day.allocations.reduce((s, a) => s + a.qty, 0);

            html += `<div class="print-day" id="print-day-${day.day}">
                <div class="print-day-header">
                    <h3>Day ${day.day} - ${dayName}</h3>
                    <div class="print-day-date">${formatDateLong(day.date)}</div>
                </div>`;

            if (day.allocations.length > 0) {
                html += `<table><thead><tr><th>Organization</th><th>Meals</th><th>Media Officer</th><th>Location</th><th>Contact Person</th><th>Contact No.</th></tr></thead><tbody>`;
                day.allocations.forEach((a, ai) => {
                    const org = appData.organizations.find(o => o.id === a.orgId);
                    const color = org ? ORG_COLORS[appData.organizations.indexOf(org) % ORG_COLORS.length] : '#999';
                    html += `<tr>
                        <td><span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:${color};margin-right:6px"></span>${esc(a.orgName)}</td>
                        <td>${a.qty.toLocaleString()}</td>
                        <td>${esc(a.mediaOfficer || '-')}</td>
                        <td>${esc(a.location || '-')}</td>
                        <td>${esc(a.contactPerson || '-')}</td>
                        <td>${esc(a.contactNumber || '-')}</td>
                    </tr>`;
                });
                html += `<tr class="total-row"><td>TOTAL</td><td>${total.toLocaleString()} / ${cap.toLocaleString()}</td><td colspan="4">${total >= cap ? 'Full' : (cap - total).toLocaleString() + ' remaining'}</td></tr>`;
                html += `</tbody></table>`;
            } else {
                html += `<p style="color:var(--gray-500);font-size:0.85rem;padding:10px 0">No allocations for this day.</p>`;
            }

            if (day.notes) {
                html += `<div style="margin-top:8px;font-size:0.8rem;color:var(--gray-500)">`;
                html += `<p><strong>Notes:</strong> ${esc(day.notes)}</p>`;
                html += `</div>`;
            }
            html += `</div>`;
        });

        document.getElementById('schedule-content').innerHTML = html;
    }

    function doPrint(cleanup) {
        window.onafterprint = function() {
            window.onafterprint = null;
            if (cleanup) cleanup();
        };
        setTimeout(function() { window.print(); }, 200);
    }

    function printSchedule() {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('print-target'));
        document.getElementById('page-schedule').classList.add('print-target');
        doPrint(function() {
            document.getElementById('page-schedule').classList.remove('print-target');
        });
    }

    function printReport() {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('print-target'));
        document.getElementById('page-reports').classList.add('print-target');
        doPrint(function() {
            document.getElementById('page-reports').classList.remove('print-target');
        });
    }

    function printSingleDay() {
        const dayNum = prompt(`Enter day number (1-${settings.totalDays}):`, '1');
        if (!dayNum) return;
        const num = parseInt(dayNum);
        if (isNaN(num) || num < 1 || num > settings.totalDays) return alert('Invalid day number.');

        // Hide all print-days, show only selected
        document.querySelectorAll('.print-day').forEach(el => el.style.display = 'none');
        const target = document.getElementById('print-day-' + num);
        if (target) target.style.display = '';

        document.querySelectorAll('.page').forEach(p => p.classList.remove('print-target'));
        document.getElementById('page-schedule').classList.add('print-target');
        doPrint(function() {
            document.getElementById('page-schedule').classList.remove('print-target');
            document.querySelectorAll('.print-day').forEach(el => el.style.display = '');
        });
    }

    function printOrgWiseSchedule() {
        if (!settings || appData.organizations.length === 0) return alert('No organizations to show.');

        // Ask user: single org or all
        const orgList = appData.organizations.map((o, i) => `${i + 1}. ${o.name}`).join('\n');
        const choice = prompt('Enter organization number for single report,\nor leave empty for ALL:\n\n' + orgList, '');
        if (choice === null) return;

        let orgsToShow = appData.organizations;
        if (choice.trim() !== '') {
            const num = parseInt(choice.trim());
            if (isNaN(num) || num < 1 || num > appData.organizations.length) return alert('Invalid number.');
            orgsToShow = [appData.organizations[num - 1]];
        }

        // Build org-wise schedule HTML
        let html = '';
        orgsToShow.forEach((org) => {
            const idx = appData.organizations.indexOf(org);
            const color = ORG_COLORS[idx % ORG_COLORS.length];
            let totalAllocated = 0;
            let daysActive = 0;

            let rows = '';
            appData.days.forEach(day => {
                const alloc = day.allocations.find(a => a.orgId === org.id);
                if (!alloc) return;
                const qty = alloc.qty;
                totalAllocated += qty;
                daysActive++;
                const dayDate = new Date(day.date + 'T00:00:00');
                const dayName = DAY_NAMES_FULL[dayDate.getDay()];
                const staff = alloc.mediaOfficer ? esc(alloc.mediaOfficer) : '';
                const loc = alloc.location ? esc(alloc.location) : '';
                const contact = alloc.contactPerson ? esc(alloc.contactPerson) + (alloc.contactNumber ? ' (' + esc(alloc.contactNumber) + ')' : '') : '';
                rows += `<tr>
                    <td><strong>Day ${day.day}</strong></td>
                    <td>${formatDate(day.date)} <span style="font-size:0.7rem;color:var(--gray-400)">${dayName}</span></td>
                    <td style="font-weight:700">${qty.toLocaleString()}</td>
                    <td>${staff}</td>
                    <td>${loc}</td>
                    <td>${contact}</td>
                    <td><span class="badge badge-${day.status === 'pending' ? 'scheduled' : day.status}">${({pending:'Scheduled',scheduled:'Scheduled',cooking:'Cooking',cooked:'Cooked',distributed:'Distributed',reported:'Reported'})[day.status] || day.status}</span></td>
                </tr>`;
            });

            const remaining = org.qty - totalAllocated;

            html += `<div class="print-day" style="border-left:5px solid ${color}">
                <div class="print-day-header" style="border-bottom-color:${color}">
                    <h3 style="color:${color}">${esc(org.name)}</h3>
                    <span class="print-day-date">${esc(getScheduleLabel(org))}</span>
                </div>
                <div style="display:flex;gap:16px;flex-wrap:wrap;margin-bottom:10px;font-size:0.82rem">
                    <span><strong>Total:</strong> ${org.qty.toLocaleString()}</span>
                    <span><strong>Allocated:</strong> ${totalAllocated.toLocaleString()}</span>
                    <span><strong>Remaining:</strong> ${remaining.toLocaleString()}</span>
                    <span><strong>Days:</strong> ${daysActive} / ${settings.totalDays}</span>
                    <span><strong>Min/Day:</strong> ${(org.minPerDay || 100).toLocaleString()}</span>
                    ${org.contact ? '<span><strong>Contact:</strong> ' + esc(org.contact) + '</span>' : ''}
                    ${org.phone ? '<span><strong>Phone:</strong> ' + esc(org.phone) + '</span>' : ''}
                </div>
                ${rows ? `<table>
                    <thead><tr><th>Day</th><th>Date</th><th>Meals</th><th>Staff</th><th>Location</th><th>Contact</th><th>Status</th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>` : '<p style="color:var(--gray-400);font-size:0.85rem">No allocations yet</p>'}
            </div>`;
        });

        // Inject into schedule content area temporarily
        const scheduleContent = document.getElementById('schedule-content');
        const originalContent = scheduleContent.innerHTML;
        scheduleContent.innerHTML = `<div id="org-schedule-print">
            <div style="text-align:center;margin-bottom:16px">
                <h2 style="font-size:1.1rem;color:var(--primary);margin-bottom:4px">${esc(settings.orgName)}  Organization Wise Schedule</h2>
                <p style="font-size:0.78rem;color:var(--gray-500)">${settings.totalDays} Days | ${formatDate(settings.startDate)} onwards | Generated ${new Date().toLocaleDateString()}</p>
            </div>
            ${html}
        </div>`;

        document.querySelectorAll('.page').forEach(p => p.classList.remove('print-target'));
        document.getElementById('page-schedule').classList.add('print-target');
        doPrint(function() {
            document.getElementById('page-schedule').classList.remove('print-target');
            scheduleContent.innerHTML = originalContent;
        });
    }

    // ===================== DASHBOARD =====================
    function renderDashboard() {
        if (!settings) return;
        const cap = settings.dailyCapacity;
        const totalDays = settings.totalDays;
        const totalReceived = appData.organizations.reduce((s, o) => s + o.qty, 0);
        const totalAllocated = appData.days.reduce((s, d) => s + d.allocations.reduce((ss, a) => ss + a.qty, 0), 0);
        const totalCooked = appData.days.reduce((s, d) => s + d.actualCooked, 0);
        const totalDistributed = appData.days.reduce((s, d) => s + d.actualDistributed, 0);
        const totalCapacity = cap * totalDays;
        const unallocated = totalReceived - totalAllocated;
        const daysFullyAllocated = appData.days.filter(d => d.allocations.reduce((s, a) => s + a.qty, 0) >= cap).length;
        const daysCookedOrDist = appData.days.filter(d => d.status === 'cooked' || d.status === 'distributed' || d.status === 'cooking' || d.status === 'reported').length;
        const shortfall = totalCapacity - totalReceived;

        document.getElementById('dashboard-stats').innerHTML = `
            <div class="stat-card"><div class="stat-label">Total Received</div><div class="stat-value">${totalReceived.toLocaleString()}</div><div class="stat-sub">from ${appData.organizations.length} org(s)</div></div>
            <div class="stat-card accent"><div class="stat-label">Total Capacity</div><div class="stat-value">${totalCapacity.toLocaleString()}</div><div class="stat-sub">${cap.toLocaleString()} x ${totalDays} days</div></div>
            <div class="stat-card info"><div class="stat-label">Allocated</div><div class="stat-value">${totalAllocated.toLocaleString()}</div><div class="stat-sub">${unallocated > 0 ? unallocated.toLocaleString() + ' unallocated' : 'All allocated'}</div></div>
            <div class="stat-card success"><div class="stat-label">Cooked / Distributed</div><div class="stat-value">${totalCooked.toLocaleString()} / ${totalDistributed.toLocaleString()}</div><div class="stat-sub">${daysCookedOrDist} of ${totalDays} days done</div></div>
            <div class="stat-card ${shortfall > 0 ? 'danger' : 'success'}"><div class="stat-label">${shortfall > 0 ? 'Shortfall' : 'Surplus'}</div><div class="stat-value">${Math.abs(shortfall).toLocaleString()}</div><div class="stat-sub">${shortfall > 0 ? 'meals still needed' : 'extra meals available'}</div></div>
            <div class="stat-card warning"><div class="stat-label">Days Fully Planned</div><div class="stat-value">${daysFullyAllocated} / ${totalDays}</div><div class="stat-sub">${totalDays - daysFullyAllocated} days need attention</div></div>`;

        let alerts = '';
        if (shortfall > 0) alerts += `<div class="alert alert-danger">&#9888; Shortfall: Need ${shortfall.toLocaleString()} more meals to cover all ${totalDays} days at full capacity.</div>`;
        if (unallocated > 0 && totalAllocated > 0) alerts += `<div class="alert alert-warning">&#9432; ${unallocated.toLocaleString()} meals not yet allocated. Use Auto-Schedule in Daily Plan.</div>`;
        if (totalReceived === 0) alerts += `<div class="alert alert-warning">&#9432; No organizations added yet. Start in the Organizations tab.</div>`;
        if (totalReceived > 0 && totalAllocated === 0) alerts += `<div class="alert alert-warning">&#9432; Meals received but not scheduled. Use Auto-Schedule in Daily Plan.</div>`;
        if (shortfall <= 0 && daysFullyAllocated === totalDays) alerts += `<div class="alert alert-success">&#10003; All ${totalDays} days fully planned!</div>`;
        document.getElementById('alerts-container').innerHTML = alerts;

        // Today's Schedule
        const todayContainer = document.getElementById('dashboard-today');
        const now = new Date();
        const todayStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
        const todayDay = appData.days.find(d => d.date === todayStr);
        if (todayDay) {
            const todayDate = new Date(todayDay.date + 'T00:00:00');
            const dayName = DAY_NAMES_FULL[todayDate.getDay()];
            const todayTotal = todayDay.allocations.reduce((s, a) => s + a.qty, 0);
            const todayRemaining = cap - todayTotal;
            const todayPct = cap > 0 ? Math.min(Math.round(todayTotal / cap * 100), 100) : 0;
            const todayStatusMap = { pending:'Scheduled', scheduled:'Scheduled', cooking:'Cooking', cooked:'Cooked', distributed:'Distributed', reported:'Reported' };
            const todayColorMap = { pending:'var(--warning)', scheduled:'var(--warning)', cooking:'#e65100', cooked:'var(--success)', distributed:'var(--info)', reported:'#7b1fa2' };
            const todayDisplayStatus = todayDay.status === 'pending' ? 'scheduled' : todayDay.status;
            const statusLabel = todayStatusMap[todayDay.status] || todayDay.status;
            const statusColor = todayColorMap[todayDay.status] || 'var(--warning)';

            let todayHtml = `<div class="card" style="border-left:4px solid ${statusColor};margin-bottom:16px">
                <div class="card-title" style="margin-bottom:12px">
                    <span>Today's Schedule - Day ${todayDay.day}</span>
                    <span class="badge badge-${todayDisplayStatus}" style="font-size:0.75rem">${statusLabel}</span>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:4px">
                    <span style="font-size:0.88rem;color:var(--gray-700)">${dayName}, ${formatDate(todayDay.date)}</span>
                    <span style="font-size:0.88rem;font-weight:600">${todayTotal.toLocaleString()} / ${cap.toLocaleString()} meals planned</span>
                </div>
                <div class="progress-bar" style="height:10px;margin-bottom:14px">
                    <div class="progress-fill ${todayPct >= 100 ? 'green' : todayPct >= 50 ? 'yellow' : 'red'}" style="width:${todayPct}%"></div>
                </div>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:8px;margin-bottom:14px">
                    <div style="background:var(--gray-50);border-radius:8px;padding:10px;text-align:center">
                        <div style="font-size:0.7rem;color:var(--gray-500);text-transform:uppercase;font-weight:600">Planned</div>
                        <div style="font-size:1.2rem;font-weight:700;color:var(--primary)">${todayTotal.toLocaleString()}</div>
                    </div>
                    <div style="background:var(--gray-50);border-radius:8px;padding:10px;text-align:center">
                        <div style="font-size:0.7rem;color:var(--gray-500);text-transform:uppercase;font-weight:600">Cooked</div>
                        <div style="font-size:1.2rem;font-weight:700;color:var(--success)">${todayDay.actualCooked.toLocaleString()}</div>
                    </div>
                    <div style="background:var(--gray-50);border-radius:8px;padding:10px;text-align:center">
                        <div style="font-size:0.7rem;color:var(--gray-500);text-transform:uppercase;font-weight:600">Distributed</div>
                        <div style="font-size:1.2rem;font-weight:700;color:var(--info)">${todayDay.actualDistributed.toLocaleString()}</div>
                    </div>
                    <div style="background:var(--gray-50);border-radius:8px;padding:10px;text-align:center">
                        <div style="font-size:0.7rem;color:var(--gray-500);text-transform:uppercase;font-weight:600">${todayRemaining > 0 ? 'Gap' : 'Status'}</div>
                        <div style="font-size:1.2rem;font-weight:700;color:${todayRemaining > 0 ? 'var(--danger)' : 'var(--success)'}">${todayRemaining > 0 ? todayRemaining.toLocaleString() : 'Full'}</div>
                    </div>
                </div>`;

            if (todayDay.allocations.length > 0) {
                todayHtml += `<div class="table-wrap"><table>
                    <thead><tr><th>Organization</th><th>Meals</th><th>Staff</th><th>Location</th><th>Contact</th><th>Phone</th></tr></thead><tbody>`;
                todayDay.allocations.forEach(a => {
                    todayHtml += `<tr>
                        <td><strong>${esc(a.orgName)}</strong></td>
                        <td style="font-weight:600">${a.qty.toLocaleString()}</td>
                        <td>${esc(a.mediaOfficer || '-')}</td>
                        <td>${esc(a.location || '-')}</td>
                        <td>${esc(a.contactPerson || '-')}</td>
                        <td>${a.contactNumber ? '<a href="tel:' + esc(a.contactNumber) + '">' + esc(a.contactNumber) + '</a>' : '-'}</td>
                    </tr>`;
                });
                todayHtml += `</tbody></table></div>`;
            } else {
                todayHtml += `<div style="text-align:center;color:var(--gray-500);padding:16px;font-size:0.88rem">No organizations allocated for today yet.</div>`;
            }

            if (todayDay.notes) {
                todayHtml += `<div style="margin-top:10px;padding:10px 14px;background:var(--accent-light);border-radius:8px;font-size:0.85rem"><strong>Notes:</strong> ${esc(todayDay.notes)}</div>`;
            }
            if (todayDay.mediaLink) {
                todayHtml += `<div style="margin-top:8px;padding:10px 14px;background:#e3f2fd;border-radius:8px;font-size:0.85rem"><strong>Media:</strong> <a href="${esc(todayDay.mediaLink)}" target="_blank" style="color:#1565c0;word-break:break-all">${esc(todayDay.mediaLink)}</a></div>`;
            }

            todayHtml += `<div style="margin-top:12px;text-align:right">
                <button class="btn btn-sm btn-primary" onclick="openDayModal(${todayDay.day})">Edit Today's Schedule</button>
            </div></div>`;

            todayContainer.innerHTML = todayHtml;
        } else {
            todayContainer.innerHTML = '';
        }

        // Chart
        let chartHtml = '<div style="display:flex;align-items:flex-end;gap:3px;height:120px;padding:10px 0">';
        appData.days.forEach(day => {
            const total = day.allocations.reduce((s, a) => s + a.qty, 0);
            const pct = cap > 0 ? Math.min(Math.round(total / cap * 100), 100) : 0;
            const color = pct >= 100 ? 'var(--success)' : pct >= 50 ? 'var(--warning)' : pct > 0 ? 'var(--danger)' : 'var(--gray-200)';
            chartHtml += `<div style="flex:1;display:flex;flex-direction:column;align-items:center" title="Day ${day.day}: ${total}/${cap}">
                <div style="font-size:0.55rem;color:var(--gray-500);margin-bottom:2px">${total > 0 ? total : ''}</div>
                <div style="width:100%;background:${color};border-radius:2px 2px 0 0;height:${Math.max(pct, 2)}%;min-height:2px"></div>
                <div style="font-size:0.55rem;color:var(--gray-500);margin-top:2px">${day.day}</div>
            </div>`;
        });
        chartHtml += `</div><div style="font-size:0.7rem;color:var(--gray-500);text-align:center;margin-top:4px">Daily capacity: ${cap.toLocaleString()} meals</div>`;
        document.getElementById('capacity-chart').innerHTML = chartHtml;

        // Dashboard org table
        const dtbody = document.querySelector('#dashboard-org-table tbody');
        if (appData.organizations.length === 0) {
            dtbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--gray-500)">No organizations yet</td></tr>';
        } else {
            dtbody.innerHTML = appData.organizations.map((org, idx) => {
                const pct = totalReceived > 0 ? ((org.qty / totalReceived) * 100).toFixed(1) : 0;
                const daysCovered = cap > 0 ? (org.qty / (org.minPerDay || 100)).toFixed(0) : 0;
                const color = ORG_COLORS[idx % ORG_COLORS.length];
                return `<tr>
                    <td><span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:${color};margin-right:6px"></span>${esc(org.name)}</td>
                    <td>${org.qty.toLocaleString()}</td>
                    <td><span class="badge badge-${org.scheduleType}">${esc(getScheduleLabel(org))}</span></td>
                    <td>${(org.minPerDay || 100).toLocaleString()}</td>
                    <td>${pct}%</td>
                    <td>${daysCovered} days</td>
                </tr>`;
            }).join('');
        }
    }

    // ===================== DISTRIBUTION LOG =====================
    function renderDistribution() {
        const tbody = document.querySelector('#dist-table tbody');
        tbody.innerHTML = appData.days.map(day => {
            const planned = day.allocations.reduce((s, a) => s + a.qty, 0);
            const orgDetails = day.allocations.map(a => {
                let line = `<strong>${esc(a.orgName)}</strong> (${a.qty})`;
                if (a.mediaOfficer) line += ` - ${esc(a.mediaOfficer)}`;
                if (a.location) line += ` <span style="color:var(--gray-500)">@ ${esc(a.location)}</span>`;
                if (a.contactPerson) line += ` <span style="color:var(--gray-400)">[${esc(a.contactPerson)}${a.contactNumber ? ': ' + esc(a.contactNumber) : ''}]</span>`;
                return line;
            }).join('<br>') || '-';
            const dStatus = day.status === 'pending' ? 'scheduled' : day.status;
            const dStatusNames = { scheduled:'Scheduled', cooking:'Cooking', cooked:'Cooked', distributed:'Distributed', reported:'Reported', pending:'Scheduled' };
            return `<tr>
                <td><strong>Day ${day.day}</strong></td>
                <td>${formatDate(day.date)}</td>
                <td style="font-size:0.78rem">${orgDetails}</td>
                <td>${planned.toLocaleString()}</td>
                <td>${day.actualCooked.toLocaleString()}</td>
                <td>${day.actualDistributed.toLocaleString()}</td>
                <td><span class="badge badge-${dStatus}">${dStatusNames[dStatus] || dStatus}</span>${day.mediaLink ? ' <a href="' + esc(day.mediaLink) + '" target="_blank" style="font-size:0.7rem;color:var(--info)">Media</a>' : ''}</td>
                <td><button class="btn btn-sm btn-outline" onclick="openDayModal(${day.day})">Update</button></td>
            </tr>`;
        }).join('');
    }

    // ===================== REPORTS =====================
    function renderReports() {
        if (!settings) return;
        const cap = settings.dailyCapacity;
        const totalDays = settings.totalDays;
        const totalReceived = appData.organizations.reduce((s, o) => s + o.qty, 0);
        const totalCapacity = cap * totalDays;
        const totalCooked = appData.days.reduce((s, d) => s + d.actualCooked, 0);
        const totalDistributed = appData.days.reduce((s, d) => s + d.actualDistributed, 0);
        const daysCompleted = appData.days.filter(d => d.status === 'distributed').length;

        let html = `<table style="margin-bottom:20px">
            <tr><td style="font-weight:600;padding:8px 16px 8px 0">Organization</td><td>${esc(settings.orgName)}</td></tr>
            <tr><td style="font-weight:600;padding:8px 16px 8px 0">Daily Capacity</td><td>${cap.toLocaleString()} meals</td></tr>
            <tr><td style="font-weight:600;padding:8px 16px 8px 0">Total Capacity (${totalDays} days)</td><td>${totalCapacity.toLocaleString()} meals</td></tr>
            <tr><td style="font-weight:600;padding:8px 16px 8px 0">Total Received</td><td>${totalReceived.toLocaleString()} meals</td></tr>
            <tr><td style="font-weight:600;padding:8px 16px 8px 0">Total Cooked</td><td>${totalCooked.toLocaleString()} meals</td></tr>
            <tr><td style="font-weight:600;padding:8px 16px 8px 0">Total Distributed</td><td>${totalDistributed.toLocaleString()} meals</td></tr>
            <tr><td style="font-weight:600;padding:8px 16px 8px 0">Days Completed</td><td>${daysCompleted} / ${totalDays}</td></tr>
            <tr><td style="font-weight:600;padding:8px 16px 8px 0">Coverage</td><td>${totalCapacity > 0 ? ((totalReceived / totalCapacity) * 100).toFixed(1) : 0}%</td></tr>
        </table>
        <h3 style="font-size:1rem;margin-bottom:10px">Organization Breakdown</h3>
        <table style="margin-bottom:20px">
            <thead><tr><th>Organization</th><th>Meals</th><th>Schedule</th><th>Min/Day</th><th>Share %</th><th>Contact</th></tr></thead>
            <tbody>${appData.organizations.map(org => `<tr>
                <td>${esc(org.name)}</td>
                <td>${org.qty.toLocaleString()}</td>
                <td>${esc(getScheduleLabel(org))}</td>
                <td>${(org.minPerDay || 100).toLocaleString()}</td>
                <td>${totalReceived > 0 ? ((org.qty / totalReceived) * 100).toFixed(1) : 0}%</td>
                <td>${esc(org.contact || '-')} ${esc(org.phone || '')}</td>
            </tr>`).join('') || '<tr><td colspan="6">No organizations</td></tr>'}
            </tbody>
        </table>
        <h3 style="font-size:1rem;margin-bottom:10px">Daily Log</h3>
        <table>
            <thead><tr><th>Day</th><th>Date</th><th>Org - Staff - Location</th><th>Planned</th><th>Cooked</th><th>Distributed</th><th>Status</th></tr></thead>
            <tbody>${appData.days.map(day => {
                const planned = day.allocations.reduce((s, a) => s + a.qty, 0);
                const orgs = day.allocations.map(a => {
                    let t = a.orgName + ' (' + a.qty + ')';
                    if (a.mediaOfficer) t += ' - ' + a.mediaOfficer;
                    if (a.location) t += ' @ ' + a.location;
                    if (a.contactPerson) t += ' [' + a.contactPerson + (a.contactNumber ? ': ' + a.contactNumber : '') + ']';
                    return t;
                }).join(', ') || '-';
                return `<tr>
                    <td>Day ${day.day}</td>
                    <td>${formatDate(day.date)}</td>
                    <td style="font-size:0.78rem">${esc(orgs)}</td>
                    <td>${planned.toLocaleString()}</td>
                    <td>${day.actualCooked.toLocaleString()}</td>
                    <td>${day.actualDistributed.toLocaleString()}</td>
                    <td>${day.status}</td>
                </tr>`;
            }).join('')}
            </tbody>
        </table>`;

        document.getElementById('report-content').innerHTML = html;
    }

    // ===================== UPDATES =====================
    let _updatesCache = [];

    function populateUpdateDaySelect() {
        const sel = document.getElementById('updateDay');
        if (!sel || !settings) return;
        const now = new Date();
        const todayStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
        sel.innerHTML = '<option value="0">No day</option>' + appData.days.map(d =>
            `<option value="${d.day}"${d.date === todayStr ? ' selected' : ''}>Day ${d.day} - ${formatDate(d.date)}${d.date === todayStr ? ' (Today)' : ''}</option>`
        ).join('');
    }

    function previewUpdatePhoto(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            document.getElementById('updatePhotoName').textContent = file.name;
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('updatePhotoImg').src = e.target.result;
                document.getElementById('updatePhotoPreview').style.display = 'flex';
            };
            reader.readAsDataURL(file);
        }
    }

    function clearUpdatePhoto() {
        document.getElementById('updatePhoto').value = '';
        document.getElementById('updatePhotoName').textContent = '';
        document.getElementById('updatePhotoPreview').style.display = 'none';
    }

    async function postUpdate() {
        const staff = document.getElementById('updateStaff').value.trim();
        const message = document.getElementById('updateMessage').value.trim();
        const type = document.getElementById('updateType').value;
        const day = document.getElementById('updateDay').value;
        const photoInput = document.getElementById('updatePhoto');

        if (!staff) return alert('Please enter your name.');
        if (!message && !(photoInput.files && photoInput.files[0])) return alert('Please enter a message or add a photo.');

        const formData = new FormData();
        formData.append('staff', staff);
        formData.append('message', message);
        formData.append('type', type);
        formData.append('day', day);
        if (photoInput.files && photoInput.files[0]) {
            formData.append('photo', photoInput.files[0]);
        }

        try {
            const resp = await fetch('/api/updates', { method: 'POST', body: formData });
            if (resp.ok) {
                // Remember staff name for next time
                localStorage.setItem('ifthar_staff_name', staff);
                document.getElementById('updateMessage').value = '';
                clearUpdatePhoto();
                await fetchAndRenderUpdates();
            } else {
                alert('Failed to post update.');
            }
        } catch (e) {
            alert('Error posting update: ' + e.message);
        }
    }

    async function deleteUpdate(id) {
        if (!confirm('Delete this update?')) return;
        try {
            await fetch('/api/updates/' + id, { method: 'DELETE' });
            await fetchAndRenderUpdates();
        } catch (e) {}
    }

    // deleteAllUpdates removed - data protection

    function openPhotoLightbox(src) {
        const lb = document.createElement('div');
        lb.className = 'photo-lightbox';
        lb.innerHTML = '<img src="' + src + '">';
        lb.onclick = function() { lb.remove(); };
        document.body.appendChild(lb);
    }

    function formatTimeAgo(ts) {
        const now = new Date();
        const date = new Date(ts);
        const diffMs = now - date;
        const diffMin = Math.floor(diffMs / 60000);
        if (diffMin < 1) return 'Just now';
        if (diffMin < 60) return diffMin + 'm ago';
        const diffHr = Math.floor(diffMin / 60);
        if (diffHr < 24) return diffHr + 'h ago';
        const diffDay = Math.floor(diffHr / 24);
        if (diffDay < 7) return diffDay + 'd ago';
        return date.toLocaleDateString();
    }

    async function fetchAndRenderUpdates() {
        try {
            const resp = await fetch('/api/updates');
            if (resp.ok) _updatesCache = await resp.json();
        } catch (e) {}
        renderUpdatesFeed();
    }

    function getInitials(name) {
        return name.split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase();
    }

    let _updatesFilter = 'all';
    function filterUpdates(type, btn) {
        _updatesFilter = type;
        document.querySelectorAll('.upd-filter-pill').forEach(p => p.classList.remove('active'));
        if (btn) btn.classList.add('active');
        renderUpdatesFeed();
    }

    function renderUpdatesFeed() {
        const feed = document.getElementById('updates-feed');
        if (!feed) return;

        const filtered = _updatesFilter === 'all' ? _updatesCache : _updatesCache.filter(u => u.type === _updatesFilter);

        if (_updatesCache.length === 0) {
            feed.innerHTML = `<div class="update-empty">
                <div class="update-empty-icon">&#128247;</div>
                <div class="update-empty-text">No updates yet</div>
                <div class="update-empty-sub">Be the first to share what's happening!</div>
            </div>`;
            return;
        }

        if (filtered.length === 0) {
            feed.innerHTML = `<div class="update-empty">
                <div class="update-empty-icon">&#128269;</div>
                <div class="update-empty-text">No ${_updatesFilter} updates</div>
                <div class="update-empty-sub">Try a different filter</div>
            </div>`;
            return;
        }

        let html = '<div class="upd-feed-header">';
        html += '<span class="upd-feed-count">' + filtered.length + ' update' + (filtered.length !== 1 ? 's' : '') + '</span>';
        html += '';
        html += '</div>';

        filtered.forEach(u => {
            const initials = getInitials(u.staff || '?');
            const dayLabel = u.day > 0 ? `<span class="update-day-badge">Day ${u.day}</span>` : '';
            const typeColors = { cooking:'#27ae60', distribution:'#2980b9', issue:'#e74c3c', general:'#c8a23d' };
            const avatarBg = typeColors[u.type] || '#999';
            html += `<div class="update-card type-${u.type}">
                <div class="update-card-header">
                    <div class="update-card-avatar" style="background:${avatarBg}">${initials}</div>
                    <div class="update-card-info">
                        <span class="update-staff">${esc(u.staff)}</span>
                        <div class="update-meta-row">
                            <span class="update-type-badge ${u.type}">${u.type}</span>
                            ${dayLabel}
                            <span class="update-time">${formatTimeAgo(u.timestamp)}</span>
                        </div>
                    </div>
                    <div class="update-card-actions">
                        <button class="update-delete" onclick="deleteUpdate('${u.id}')" title="Delete">
                            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/></svg>
                        </button>
                    </div>
                </div>`;
            if (u.message) {
                html += `<div class="update-message">${esc(u.message)}</div>`;
            }
            if (u.photo) {
                html += `<img class="update-photo-thumb" src="${u.photo}" onclick="openPhotoLightbox('${u.photo}')" loading="lazy">`;
            }
            html += `<div class="update-card-footer">
                <div class="update-reactions">
                    <button class="update-react-btn" onclick="this.classList.toggle('reacted')">&#128077;</button>
                    <button class="update-react-btn" onclick="this.classList.toggle('reacted')">&#10084;&#65039;</button>
                    <button class="update-react-btn" onclick="this.classList.toggle('reacted')">&#128588;</button>
                </div>
            </div>`;
            html += `</div>`;
        });
        feed.innerHTML = html;
    }

    function updateComposeAvatar() {
        const name = (document.getElementById('updateStaff').value || '').trim();
        const avatar = document.getElementById('updAvatar');
        if (avatar) avatar.textContent = name ? getInitials(name) : '?';
    }

    function renderUpdates() {
        populateUpdateDaySelect();
        // Show compose bar
        var composeBar = document.getElementById('updCompose');
        if (composeBar) composeBar.style.display = '';
        // Restore saved staff name
        const savedName = localStorage.getItem('ifthar_staff_name');
        const staffInput = document.getElementById('updateStaff');
        if (savedName && staffInput && !staffInput.value) {
            staffInput.value = savedName;
        }
        // Update avatar on name input
        if (staffInput && !staffInput._avatarBound) {
            staffInput.addEventListener('input', updateComposeAvatar);
            staffInput._avatarBound = true;
        }
        // Auto-expand textarea
        var msgInput = document.getElementById('updateMessage');
        if (msgInput && !msgInput._autoExpand) {
            msgInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 80) + 'px';
            });
            msgInput._autoExpand = true;
        }
        updateComposeAvatar();
        fetchAndRenderUpdates();
    }

    // ===================== LIVE DISPLAY =====================
    function getSelectedLiveDay() {
        const sel = document.getElementById('liveDaySelect');
        if (sel && sel.value) {
            const idx = parseInt(sel.value);
            if (!isNaN(idx) && appData.days[idx]) return appData.days[idx];
        }
        // Default: find today or first day
        const now = new Date();
        const todayStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
        const todayDay = appData.days.find(d => d.date === todayStr);
        return todayDay || appData.days[0] || null;
    }

    let _liveDayUserSelected = false;
    function populateLiveDaySelect() {
        const sel = document.getElementById('liveDaySelect');
        if (!sel || !settings) return;
        const now = new Date();
        const todayStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
        const todayIdx = appData.days.findIndex(d => d.date === todayStr);
        const prevVal = sel.value;
        sel.innerHTML = appData.days.map((d, i) => {
            const isToday = d.date === todayStr;
            return `<option value="${i}">Day ${d.day} - ${formatDate(d.date)}${isToday ? ' (Today)' : ''}</option>`;
        }).join('');
        if (_liveDayUserSelected && prevVal) {
            sel.value = prevVal;
        } else if (todayIdx >= 0) {
            sel.value = todayIdx;
        }
        sel.onchange = function() { _liveDayUserSelected = true; renderLiveDisplay(); };
    }

    function getLiveDisplayHTML() {
        if (!settings) return '<div class="live-screen"><p style="text-align:center;padding:60px;font-size:1.3rem;color:#eee">No settings configured yet.</p></div>';
        if (!appData.days || appData.days.length === 0) return '<div class="live-screen"><p style="text-align:center;padding:60px;font-size:1.3rem;color:#eee">No days configured.</p></div>';

        const day = getSelectedLiveDay();
        if (!day) return '<div class="live-screen"><p style="text-align:center;padding:60px;font-size:1.3rem;color:#eee">No day selected.</p></div>';

        const cap = settings.dailyCapacity;
        const now = new Date();
        const todayStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
        const dayDate = new Date(day.date + 'T00:00:00');
        const dayName = DAY_NAMES_FULL[dayDate.getDay()];
        const total = day.allocations.reduce((s, a) => s + a.qty, 0);
        const pct = cap > 0 ? Math.min(Math.round(total / cap * 100), 100) : 0;
        const isToday = day.date === todayStr;

        // Overall progress
        const totalDays = settings.totalDays;
        const daysCompleted = appData.days.filter(d => d.status === 'distributed').length;
        const totalReceived = appData.organizations.reduce((s, o) => s + o.qty, 0);
        const totalDistributed = appData.days.reduce((s, d) => s + (d.actualDistributed || 0), 0);

        const maxBar = Math.max(...day.allocations.map(a => a.qty), 1);

        let html = `<div class="live-screen">`;

        // Floating particles
        html += `<div class="live-particles">`;
        for (let pi = 0; pi < 20; pi++) {
            const left = Math.random() * 100;
            const size = 2 + Math.random() * 5;
            const dur = 12 + Math.random() * 25;
            const delay = Math.random() * 12;
            html += `<div class="live-particle" style="left:${left}%;width:${size}px;height:${size}px;animation-duration:${dur}s;animation-delay:${delay}s;opacity:${0.2 + Math.random() * 0.3}"></div>`;
        }
        html += `</div>`;

        // Flash overlay for anti burn-in
        html += `<div class="tv-flash"></div>`;

        // === TOP BAR ===
        html += `<div class="tv-topbar">
            <div class="tv-logo">${esc(settings.orgName)}</div>
            <div class="tv-live-badge">LIVE</div>
            <div class="tv-clock" id="tvClock">${now.toLocaleTimeString()}</div>
        </div>`;

        // === MAIN BODY ===
        html += `<div class="tv-body">`;

        // Breaking news style banner
        html += `<div class="tv-banner">
            <h2>${isToday ? 'TODAY' : 'DAY ' + day.day} &mdash; ${dayName.toUpperCase()}</h2>
            <div class="tv-banner-sub">${formatDateLong(day.date)} &nbsp;|&nbsp; Day ${day.day} of ${totalDays}</div>
        </div>`;

        // Big stat counters
        html += `<div class="tv-stats">
            <div class="tv-stat-card"><div class="tv-stat-label">Planned Meals</div><div class="tv-stat-num gold" data-count="${total}">${total.toLocaleString()}</div></div>
            <div class="tv-stat-card"><div class="tv-stat-label">Cooked</div><div class="tv-stat-num green" data-count="${day.actualCooked || 0}">${(day.actualCooked || 0).toLocaleString()}</div></div>
            <div class="tv-stat-card"><div class="tv-stat-label">Distributed</div><div class="tv-stat-num blue" data-count="${day.actualDistributed || 0}">${(day.actualDistributed || 0).toLocaleString()}</div></div>
            <div class="tv-stat-card"><div class="tv-stat-label">Status</div><div class="tv-status ${day.status === 'pending' ? 'scheduled' : day.status}">${(day.status === 'pending' ? 'SCHEDULED' : day.status.toUpperCase())}</div></div>
        </div>`;

        // Capacity progress bar
        html += `<div class="tv-progress">
            <div class="tv-progress-info"><span>Capacity Usage</span><span>${total.toLocaleString()} / ${cap.toLocaleString()}</span></div>
            <div class="tv-progress-bar"><div class="tv-progress-fill" style="width:${pct}%"></div><div class="tv-progress-pct">${pct}%</div></div>
        </div>`;

        // Organization bars - election results bar chart
        if (day.allocations.length > 0) {
            html += `<div class="tv-org-bars">`;
            day.allocations.forEach((a, ri) => {
                const org = appData.organizations.find(o => o.id === a.orgId);
                const idx = org ? appData.organizations.indexOf(org) : 0;
                const color = ORG_COLORS[idx % ORG_COLORS.length];
                const barPct = Math.max(Math.round(a.qty / maxBar * 100), 8);
                const rowDelay = 1.1 + ri * 0.15;
                const highlightDelay = 2 + ri * 3;
                html += `<div class="tv-org-bar-row" style="animation-delay:${rowDelay}s">
                    <div class="tv-org-name">${esc(a.orgName)}</div>
                    <div class="tv-org-bar-wrap">
                        <div class="tv-org-bar-fill" style="width:${barPct}%;background:linear-gradient(90deg,${color},${color}dd);animation-delay:${rowDelay + 0.3}s">
                            <span class="tv-org-bar-qty">${a.qty.toLocaleString()}</span>
                        </div>
                    </div>
                    <div class="tv-org-details">`;
                if (a.mediaOfficer) html += `<div class="tv-org-detail"><span>${esc(a.mediaOfficer)}</span></div>`;
                if (a.location) html += `<div class="tv-org-detail">${esc(a.location)}</div>`;
                html += `</div></div>`;
            });
            // Total bar
            const totalRowDelay = 1.1 + day.allocations.length * 0.15;
            html += `<div class="tv-org-bar-row" style="animation-delay:${totalRowDelay}s">
                <div class="tv-org-name" style="color:#c8a23d;font-weight:900">TOTAL</div>
                <div class="tv-org-bar-wrap" style="border-color:rgba(200,162,61,0.3)">
                    <div class="tv-org-bar-fill" style="width:${pct}%;background:linear-gradient(90deg,#c8a23d,#e8c547);animation-delay:${totalRowDelay + 0.3}s">
                        <span class="tv-org-bar-qty" style="font-size:0.85rem">${total.toLocaleString()} / ${cap.toLocaleString()}</span>
                    </div>
                </div>
                <div class="tv-org-details"></div>
            </div>`;
            html += `</div>`;
        } else {
            html += `<div style="text-align:center;padding:20px;color:#8892b0;font-size:1rem">No allocations for this day.</div>`;
        }

        // Notes
        if (day.notes) {
            html += `<div class="tv-notes"><div class="tv-notes-label">Notes</div><div class="tv-notes-text">${esc(day.notes)}</div></div>`;
        }

        // Bottom summary cards
        html += `<div class="tv-bottom">
            <div class="tv-bottom-card"><div class="tv-bottom-label">Days Completed</div><div class="tv-bottom-val">${daysCompleted} / ${totalDays}</div></div>
            <div class="tv-bottom-card"><div class="tv-bottom-label">Total Meals Received</div><div class="tv-bottom-val">${totalReceived.toLocaleString()}</div></div>
            <div class="tv-bottom-card"><div class="tv-bottom-label">Total Distributed</div><div class="tv-bottom-val">${totalDistributed.toLocaleString()}</div></div>
        </div>`;

        // Recent updates - 4-card grid (photos & text separate)
        html += `<div class="tv-updates">
            <div class="tv-updates-title">Staff Updates</div>`;
        if (_updatesCache.length > 0) {
            const recent = _updatesCache.slice(0, 6);
            html += `<div class="tv-updates-grid">`;
            recent.forEach((u, ui) => {
                const typeIcons = { cooking:'&#127859;', distribution:'&#128230;', issue:'&#9888;&#65039;', general:'&#128172;' };
                html += `<div class="tv-ucard" style="animation-delay:${2 + ui * 0.15}s">`;
                if (u.photo) {
                    html += `<img class="tv-ucard-photo" src="${u.photo}" loading="lazy">`;
                } else {
                    html += `<div class="tv-ucard-text-icon">${typeIcons[u.type] || '&#128172;'}</div>`;
                }
                html += `<div class="tv-ucard-body">
                    <div class="tv-ucard-top">
                        <span class="tv-ucard-name">${esc(u.staff)}</span>
                        <span class="tv-ucard-badge ${u.type}">${u.type}</span>
                    </div>`;
                if (u.message) {
                    html += `<div class="tv-ucard-msg">${esc(u.message)}</div>`;
                }
                html += `<div class="tv-ucard-time">${formatTimeAgo(u.timestamp)}${u.day > 0 ? ' &bull; Day ' + u.day : ''}</div>`;
                html += `</div></div>`;
            });
            html += `</div>`;
        } else {
            html += `<div style="text-align:center;padding:14px;color:#4a5568;font-size:0.8rem">No staff updates yet. Post from the Updates tab.</div>`;
        }
        html += `</div>`;

        html += `</div>`; // end tv-body

        // Scrolling ticker at bottom - include updates in ticker too
        const updateTickerItems = _updatesCache.slice(0, 5).map(u => `${esc(u.staff)}: ${esc(u.message || 'Photo update')}`);

        const tickerItems = day.allocations.map(a => `${esc(a.orgName)}: ${a.qty.toLocaleString()} meals${a.location ? ' @ ' + esc(a.location) : ''}`);
        if (updateTickerItems.length > 0) tickerItems.push(...updateTickerItems);
        if (tickerItems.length === 0) tickerItems.push('No allocations scheduled');
        const tickerRepeat = tickerItems.concat(tickerItems); // duplicate for seamless loop
        html += `<div class="tv-ticker-wrap">
            <div class="tv-ticker-label">UPDATE</div>
            <div class="tv-ticker-content">`;
        tickerRepeat.forEach((item, ti) => {
            html += `<span class="tv-ticker-item">${item}</span>`;
            if (ti < tickerRepeat.length - 1) html += `<span class="tv-ticker-dot">&bull;</span>`;
        });
        html += `</div></div>`;

        html += `<div class="tv-footer">Auto-refreshes every 10 seconds</div>`;
        html += `</div>`;
        return html;
    }

    let _tvClockInterval = null;
    async function renderLiveDisplay() {
        if (!settings) return;
        populateLiveDaySelect();
        // Fetch updates so live display has them
        try {
            const r = await fetch('/api/updates');
            if (r.ok) _updatesCache = await r.json();
        } catch(e) {}
        const el = document.getElementById('live-display-preview');
        if (el) {
            el.innerHTML = getLiveDisplayHTML();
            // Animate number counters
            el.querySelectorAll('.tv-stat-num[data-count]').forEach(numEl => {
                const target = parseInt(numEl.dataset.count) || 0;
                if (target === 0) return;
                let current = 0;
                const step = Math.max(1, Math.ceil(target / 60));
                const interval = setInterval(() => {
                    current += step;
                    if (current >= target) { current = target; clearInterval(interval); }
                    numEl.textContent = current.toLocaleString();
                }, 25);
            });
            // Live clock
            if (_tvClockInterval) clearInterval(_tvClockInterval);
            _tvClockInterval = setInterval(() => {
                const clk = document.getElementById('tvClock');
                if (clk) clk.textContent = new Date().toLocaleTimeString();
                // Also update in popup window
                if (liveDisplayWindow && !liveDisplayWindow.closed) {
                    const pClk = liveDisplayWindow.document.getElementById('tvClock');
                    if (pClk) pClk.textContent = new Date().toLocaleTimeString();
                }
            }, 1000);
        }
    }

    function enterFullscreen() {
        const el = document.getElementById('live-display-preview');
        if (el.requestFullscreen) el.requestFullscreen();
        else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
        else if (el.msRequestFullscreen) el.msRequestFullscreen();
    }

    function fitLivePreview() {
        const el = document.getElementById('live-display-preview');
        const s = el ? el.querySelector('.live-screen') : null;
        if (!s) return;
        const isFS = document.fullscreenElement === el || document.webkitFullscreenElement === el;
        if (isFS) {
            s.style.transformOrigin = 'top left';
            const ch = s.scrollHeight;
            const wh = window.innerHeight;
            if (ch > wh) {
                const scale = wh / ch;
                s.style.transform = 'scale(' + scale + ')';
                s.style.width = (100 / scale) + '%';
            }
        } else {
            s.style.transform = 'none';
            s.style.width = '100%';
        }
    }
    document.addEventListener('fullscreenchange', fitLivePreview);
    document.addEventListener('webkitfullscreenchange', fitLivePreview);

    let liveDisplayWindow = null;
    function openLiveDisplayWindow() {
        if (liveDisplayWindow && !liveDisplayWindow.closed) {
            liveDisplayWindow.focus();
            return;
        }
        liveDisplayWindow = window.open('', 'IftharLiveDisplay', 'width=1200,height=800');
        if (!liveDisplayWindow) return alert('Popup blocked. Please allow popups for this site.');
        updateLiveDisplayWindow();
    }

    function updateLiveDisplayWindow() {
        if (!liveDisplayWindow || liveDisplayWindow.closed) return;
        const styles = document.querySelector('style').textContent;
        liveDisplayWindow.document.open();
        liveDisplayWindow.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8">
            <title>${esc(settings ? settings.orgName : 'Ifthar')} - Live Display</title>
            <style>${styles}
            body { margin: 0; padding: 0; overflow: hidden; background: #0a0a1a; }
            .live-screen { min-height: auto; transform-origin: top left; }
            </style></head><body>${getLiveDisplayHTML()}
            <scr` + `ipt>
            function fitToScreen() {
                var s = document.querySelector('.live-screen');
                if (!s) return;
                s.style.transform = 'none';
                s.style.width = '100%';
                var ch = s.scrollHeight;
                var wh = window.innerHeight;
                if (ch > wh) {
                    var scale = wh / ch;
                    s.style.transform = 'scale(' + scale + ')';
                    s.style.width = (100 / scale) + '%';
                }
            }
            fitToScreen();
            window.addEventListener('resize', fitToScreen);
            // Live clock
            setInterval(function() {
                var c = document.getElementById('tvClock');
                if (c) c.textContent = new Date().toLocaleTimeString();
            }, 1000);
            // Counter animation
            document.querySelectorAll('.tv-stat-num[data-count]').forEach(function(el) {
                var target = parseInt(el.dataset.count) || 0;
                if (!target) return;
                var current = 0, step = Math.max(1, Math.ceil(target / 60));
                var iv = setInterval(function() {
                    current += step;
                    if (current >= target) { current = target; clearInterval(iv); }
                    el.textContent = current.toLocaleString();
                }, 25);
            });
            </scr` + `ipt></body></html>`);
        liveDisplayWindow.document.close();
    }

    // Auto-refresh from server (syncs data across all clients)
    setInterval(async () => {
        try {
            const resp = await fetch('/api/data');
            if (resp.ok) {
                const parsed = await resp.json();
                if (parsed && parsed.days) {
                    migrateData(parsed);
                    const newHash = JSON.stringify(parsed);
                    if (newHash !== _lastDataHash) {
                        _lastDataHash = newHash;
                        appData = parsed;
                        localStorage.setItem('ifthar_app_data', JSON.stringify(appData));
                        refresh();
                    }
                }
            }
        } catch(e) {
            // Server unreachable, fall back to localStorage
            const freshData = localStorage.getItem('ifthar_app_data');
            if (freshData) {
                try { appData = JSON.parse(freshData); } catch(e2) {}
            }
        }
        // Also refresh settings
        try {
            const resp = await fetch('/api/settings');
            if (resp.ok) {
                const s = await resp.json();
                if (s && JSON.stringify(s) !== JSON.stringify(settings)) {
                    settings = s;
                    localStorage.setItem('ifthar_settings', JSON.stringify(s));
                    applySettings();
                }
            }
        } catch(e) {}
        // Refresh updates feed
        fetchAndRenderUpdates();
        renderLiveDisplay();
        if (liveDisplayWindow && !liveDisplayWindow.closed) updateLiveDisplayWindow();
    }, 10000);

    // ===================== IMPORT / EXPORT =====================
    function exportData() {
        const payload = { settings, appData };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const prefix = settings ? settings.orgName.toLowerCase().replace(/\s+/g, '-') : 'ifthar';
        a.download = `${prefix}-ifthar-backup-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    function importDataPrompt() { document.getElementById('importFile').click(); }

    function importData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const imported = JSON.parse(e.target.result);
                if (imported.settings && imported.appData) {
                    if (!confirm(`Import "${imported.settings.orgName}" with ${imported.appData.organizations.length} organizations?`)) return;
                    settings = imported.settings;
                    appData = imported.appData;
                    saveSettingsToStorage(settings);
                } else if (imported.organizations && imported.days) {
                    if (!confirm(`Import ${imported.organizations.length} organizations?`)) return;
                    appData = imported;
                } else { throw new Error('Invalid format'); }
                // Migrate org fields
                (appData.organizations || []).forEach(o => {
                    if (!o.minPerDay) o.minPerDay = 100;
                    if (!o.scheduleType) o.scheduleType = 'daily';
                    if (!o.scheduleDays) o.scheduleDays = [];
                    if (o.location === undefined) o.location = '';
                    if (o.mediaOfficer === undefined) o.mediaOfficer = '';
                });
                // Migrate allocation fields
                (appData.days || []).forEach(d => {
                    (d.allocations || []).forEach(a => {
                        if (a.contactPerson === undefined) a.contactPerson = '';
                        if (a.contactNumber === undefined) a.contactNumber = '';
                    });
                });
                saveData(); applySettings(); refresh();
                alert('Data imported successfully!');
            } catch(err) { alert('Invalid file: ' + err.message); }
        };
        reader.readAsText(file);
        event.target.value = '';
    }

    // ===================== HELPERS =====================
    function esc(str) { const d = document.createElement('div'); d.textContent = str; return d.innerHTML; }
    function formatDate(dateStr) {
        const d = new Date(dateStr + 'T00:00:00');
        return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    }
    function formatDateLong(dateStr) {
        const d = new Date(dateStr + 'T00:00:00');
        return d.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }

    function refresh() {
        if (!settings) return;
        renderDashboard();
        renderOrganizations();
        renderDaysGrid();
        renderSchedule();
        renderDistribution();
        renderReports();
        renderUpdates();
        renderLiveDisplay();
        const settingsPage = document.getElementById('page-settings');
        if (settingsPage && settingsPage.classList.contains('active')) loadBackups();
    }

    // Modal handlers
    document.getElementById('dayModal').addEventListener('click', function(e) { if (e.target === this) closeModal(); });
    document.getElementById('editOrgModal').addEventListener('click', function(e) { if (e.target === this) closeEditOrgModal(); });
    document.addEventListener('keydown', e => { if (e.key === 'Escape') { closeModal(); closeEditOrgModal(); } });

    // Enter to submit org form
    ['orgName','orgQty','orgMinPerDay','orgContact','orgPhone','orgNotes'].forEach(id => {
        document.getElementById(id).addEventListener('keydown', e => { if (e.key === 'Enter') addOrganization(); });
    });

    // Init - fetch shared data from server, then render
    (async function init() {
        await initFromServer();
        if (settings) { applySettings(); refresh(); }
        showSetupIfNeeded();

        // Handle ?page= URL parameter for direct links
        const urlParams = new URLSearchParams(window.location.search);
        const pageParam = urlParams.get('page');
        const modeParam = urlParams.get('mode');

        if (pageParam) {
            const targetTab = document.querySelector('.nav-tab[data-page="' + pageParam + '"]');
            if (targetTab) {
                targetTab.click();
            }
        }

        // Staff mode: hide everything except the target page
        if (modeParam === 'staff') {
            document.querySelector('.header').style.display = 'none';
            document.querySelector('.nav-tabs').style.display = 'none';
            document.querySelector('.main').style.maxWidth = '600px';
            document.querySelector('.main').style.padding = '0';
            // Hide all pages except updates
            document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
            var staffPage = document.getElementById('page-' + (pageParam || 'updates'));
            if (staffPage) staffPage.style.display = 'block';
            // Show compose bar
            var cb = document.getElementById('updCompose');
            if (cb) cb.style.display = '';
            // Add a small branded header for staff
            var staffHeader = document.createElement('div');
            staffHeader.style.cssText = 'background:linear-gradient(135deg,var(--primary-dark),var(--primary));color:white;padding:14px 16px;text-align:center;position:sticky;top:0;z-index:100;box-shadow:0 2px 8px rgba(0,0,0,0.15)';
            staffHeader.innerHTML = '<div style="font-weight:700;font-size:1rem">' + esc(settings ? settings.orgName : 'Ifthar') + '  Staff Updates</div><div style="font-size:0.72rem;opacity:0.8">Post cooking, distribution & activity updates</div>';
            document.body.insertBefore(staffHeader, document.body.firstChild);
            // Disable nav tab clicks (prevent escape)
            document.querySelectorAll('.nav-tab').forEach(t => {
                t.onclick = function(e) { e.preventDefault(); e.stopPropagation(); };
                t.style.pointerEvents = 'none';
            });
        }
    })();
    </script>
</body>
</html>